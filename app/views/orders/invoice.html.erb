<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Tax Invoice</title>

  <style>
    body {
      margin: 0;
      padding: 0;
      background: #f5f5f5;
      font-family: Arial, Helvetica, sans-serif;
    }

    .invoice-box {
      min-height: calc(297mm - 24mm);
      display: flex;
      flex-direction: column;
    }

    .invoice-body {
      flex: 1;
    }

    @media print {
      @page {
        size: A4;
        margin: 0;
      }

      .invoice-box {
        border: none !important;
      }

      body {
        background: #fff !important;
      }

      body * {
        visibility: hidden;
      }

      #print-area,
      #print-area * {
        visibility: visible;
      }

      #print-area {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
      }

      .no-print {
        display: none !important;
      }

      table, tr, td, th {
        page-break-inside: avoid !important;
      }
    }
  </style>
</head>

<body>

<!-- PRINT BUTTON -->
<div class="no-print" style="width:960px;margin:12px auto 0;text-align:right">
  <button onclick="window.print()"
    style="padding:8px 20px;border:1px solid #000;background:#fff;cursor:pointer;font-size:13px">
    Print Invoice
  </button>
</div>

<div id="print-area">

<div class="invoice-box"
     style="width:960px;margin:12px auto;background:#fff;border:1.5px solid #000;padding:20px 14px;font-size:13px;color:#000">

<div class="invoice-body">

<!-- ================= HEADER ================= -->
<div style="display:grid;
            grid-template-columns:220px 1fr 160px;
            align-items:center;
            border-bottom:1.8px solid #000;
            padding-bottom:12px">

  <!-- GST -->
  <div style="font-size:12px;line-height:1.7">
    <strong>GSTIN:</strong><br>
    10CMOPKR7200K1ZV
  </div>

  <!-- CENTER BRAND -->
  <div style="text-align:center">
    <% app_name = "Rajesh Alankar Mandir" %>
    <div style="font-size:28px;font-weight:900;color:#b30000;letter-spacing:1.2px">
      <%= app_name %>
    </div>
    <div style="font-size:14px;font-weight:700;color:#003f8f;margin-top:2px">
      Sadar Bazar, Jagdishpur, Bhojpur
    </div>
    <div style="font-size:12px;margin-top:3px">
      Phone: +91-99999-00000 | Email: sales@example.com
    </div>
  </div>

  <!-- QR + CERT -->
  <div style="text-align:right;font-size:12px">
    <% begin %>
      <% qr_text = request.original_url rescue order_url(@order) %>
      <% q = RQRCode::QRCode.new(qr_text) %>
      <div style="display:inline-block;padding:4px;border:1px solid #000;margin-bottom:6px">
        <%= raw q.as_svg(module_size: 2, standalone: true) %>
      </div>
    <% rescue %>
    <% end %>
    <div style="line-height:1.4">
      BIS Certified<br>
      100% Hallmarked
    </div>
  </div>
</div>

<!-- TITLE -->
<div style="text-align:center;font-weight:800;font-size:16px;margin:12px 0;text-decoration:underline">
  TAX INVOICE
</div>

<!-- BILL + INVOICE INFO -->
<div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:12px;font-size:12.5px">

  <div style="line-height:1.7">
    <strong>Bill To:</strong><br>
    <% if @order.customer.present? %>
      <strong><%= [@order.customer.first_name, @order.customer.last_name].join(' ') %></strong><br>
      <%= @order.customer.address %><br>
      Phone: <%= @order.customer.phone %>
    <% else %>
      Walk-in Customer
    <% end %>
  </div>

  <div style="line-height:1.7;text-align:right">
    <strong>Invoice No:</strong> <%= @order.invoice_number %><br>
    <strong>Date:</strong> <%= (@order.sale_date || Date.today).strftime('%d %b %Y') %><br>
    <strong>Order #:</strong> <%= @order.id %><br>
    <strong>Status:</strong> <%= @order.status.capitalize %>
  </div>
</div>

<!-- ITEMS TABLE -->
<table style="width:100%;border-collapse:collapse;table-layout:fixed">
<thead>
<tr style="background:#f3f3f3">
  <th style="border:1px solid #000;width:34px">Sr</th>
  <th style="border:1px solid #000;width:170px;text-align:left">Item</th>
  <th style="border:1px solid #000;width:70px">HUID</th>
  <th style="border:1px solid #000;width:60px">HSN</th>
  <th style="border:1px solid #000;width:45px">Qty</th>
  <th style="border:1px solid #000;width:75px">Gross</th>
  <th style="border:1px solid #000;width:75px">Net</th>
  <th style="border:1px solid #000;width:90px">Rate</th>
  <th style="border:1px solid #000;width:90px">Making</th>
  <th style="border:1px solid #000;width:95px">Total</th>
</tr>
</thead>

<tbody>
<% subtotal = 0 %>
<% @order.line_items.each_with_index do |li, i| %>
  <%# prefer model helper line_amount (per_gram * net * qty + making), fall back to previous formula if absent %>
  <% line = if li.respond_to?(:line_amount)
               li.line_amount.to_f
             else
               (li.net_weight.to_f * li.quantity.to_i * (li.price_cents.to_f / 100.0)) + li.making_charge.to_f
             end %>
  <% subtotal += line %>
<tr>
  <td style="border:1px solid #000;text-align:center"><%= i+1 %></td>
  <td style="border:1px solid #000;padding-left:6px"><strong><%= li.jewelry_item&.name %></strong></td>
  <td style="border:1px solid #000;text-align:center">-</td>
  <td style="border:1px solid #000;text-align:center"><%= li.hsn %></td>
  <td style="border:1px solid #000;text-align:center"><%= li.quantity %></td>
  <td style="border:1px solid #000;text-align:center"><%= li.gross_weight %></td>
  <td style="border:1px solid #000;text-align:center"><%= li.net_weight %></td>
  <%# show rate as per-gram price (model exposes per_gram_price) %>
  <td style="border:1px solid #000;text-align:right;padding-right:6px">₹<%= '%.2f' % (li.respond_to?(:per_gram_price) ? li.per_gram_price.to_f : (li.price_cents.to_f/100.0)) %></td>
  <td style="border:1px solid #000;text-align:right;padding-right:6px">₹<%= '%.2f' % li.making_charge %></td>
  <td style="border:1px solid #000;text-align:right;padding-right:6px;font-weight:700">₹<%= '%.2f' % line %></td>
</tr>
<% end %>
</tbody>
</table>

</div>

<!-- ================= SUMMARY ================= -->
<div style="display:grid;grid-template-columns:1fr 360px;gap:16px;margin-top:16px;font-size:12.5px">

  <!-- Left empty / notes -->
  <div></div>

  <!-- Amount Summary -->
  <div>
    <table style="width:100%;border-collapse:collapse">
      <% gross_total = subtotal %>
      <% taxable_amount = gross_total - (@order.discount.to_f || 0.0) + (@order.charges.to_f || 0.0) %>
      <% cgst_amt = taxable_amount * (@order.cgst_rate.to_f / 100.0) %>
      <% igst_amt = taxable_amount * (@order.igst_rate.to_f / 100.0) %>
      <% total = taxable_amount + cgst_amt + igst_amt %>
      <% rounded_total = total.round(0) %>

      <tr>
        <td style="border:1px solid #000;padding:6px">Gross Total</td>
        <td style="border:1px solid #000;padding:6px;text-align:right">
          ₹<%= '%.2f' % gross_total %>
        </td>
      </tr>

      <tr>
        <td style="border:1px solid #000;padding:6px">Taxable Amount</td>
        <td style="border:1px solid #000;padding:6px;text-align:right">
          ₹<%= '%.2f' % taxable_amount %>
        </td>
      </tr>

      <tr>
        <td style="border:1px solid #000;padding:6px">
          CGST <%= @order.cgst_rate.to_f %>%
        </td>
        <td style="border:1px solid #000;padding:6px;text-align:right">
          ₹<%= '%.2f' % cgst_amt %>
        </td>
      </tr>

      <tr>
        <td style="border:1px solid #000;padding:6px">
          IGST <%= @order.igst_rate.to_f %>%
        </td>
        <td style="border:1px solid #000;padding:6px;text-align:right">
          ₹<%= '%.2f' % igst_amt %>
        </td>
      </tr>

      <tr>
        <td style="border:1px solid #000;padding:6px;font-weight:700">Total</td>
        <td style="border:1px solid #000;padding:6px;text-align:right;font-weight:700">
          ₹<%= '%.2f' % total %>
        </td>
      </tr>

      <tr>
        <td style="border:1px solid #000;padding:6px">Round Off</td>
        <td style="border:1px solid #000;padding:6px;text-align:right">
          ₹<%= '%.2f' % (rounded_total - total) %>
        </td>
      </tr>

      <tr>
        <td style="border:1px solid #000;padding:7px;font-size:14px;font-weight:800">
          Net Amount
        </td>
        <td style="border:1px solid #000;padding:7px;text-align:right;font-size:14px;font-weight:800">
          ₹<%= '%.2f' % rounded_total %>
        </td>
      </tr>
    </table>
  </div>
</div>


<!-- FOOTER -->
<div style="display:flex;justify-content:space-between;margin-top:34px;font-size:12px">
  <div>
    Customer Signature
    <div style="margin-top:30px;border-top:1px solid #000;width:200px"></div>
  </div>
  <div style="text-align:right">
    For <%= app_name %>
    <div style="margin-top:30px;border-top:1px solid #000;width:200px;margin-left:auto"></div>
    Authorized Signatory
  </div>
</div>

</div>
</div>

</body>
</html>
