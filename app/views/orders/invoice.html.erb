<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Tax Invoice</title>

  <style>
    body {
      margin: 0;
      padding: 0;
      background: #f5f5f5;
      font-family: Arial, Helvetica, sans-serif;
    }

    .invoice-box {
      min-height: calc(297mm - 24mm);
      display: flex;
      flex-direction: column;
    }

    .invoice-body {
      flex: 1;
    }

    @media print {
      @page {
        size: A4;
        margin: 0;
      }

      .invoice-box {
        border: none !important;
      }

      body {
        background: #fff !important;
      }

      body * {
        visibility: hidden;
      }

      #print-area,
      #print-area * {
        visibility: visible;
      }

      #print-area {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
      }

      .no-print {
        display: none !important;
      }

      table, tr, td, th {
        page-break-inside: avoid !important;
      }
      /* make table headers use sensible defaults; per-column inline styles will override */
      th { text-align: left; }
    }
  </style>
</head>

<body>

<!-- PRINT BUTTON -->
<div class="no-print" style="width:1100px;margin:12px auto 0;text-align:right">
  <button onclick="window.print()"
    style="padding:8px 20px;border:1px solid #000;background:#fff;cursor:pointer;font-size:13px">
    Print Invoice
  </button>
</div>

<div id="print-area">

<div class="invoice-box"
  style="width:960px;margin:12px auto;background:#fff;border:1.5px solid #000;padding:20px 14px;font-size:13px;color:#000;display:flex;flex-direction:column;min-height:calc(297mm - 40mm)">

<div class="invoice-body">

<!-- ================= HEADER ================= -->
<div style="display:grid;
            grid-template-columns:220px 1fr 160px;
            align-items:center;
            border-bottom:1.8px solid #000;
            padding-bottom:12px">
  <!-- GST -->
  <div style="font-size:12px;line-height:1.7">
    <strong>GSTIN:</strong><br>
    10CMOPK8720K1ZV<br>
   <strong>A/C:</strong> 32606206871<br>
   <strong>IFSC:</strong> SBIN0010769<br>
   <strong>B Name:</strong> SUDHIR KUMAR
  </div>

  <!-- CENTER BRAND -->
  <div style="text-align:center">
    <% app_name = "Rajesh Alankar Mandir" %>
    <div style="font-size:28px;font-weight:900;color:#b30000;letter-spacing:1.2px">
      <%= app_name %>
    </div>
    <div style="font-size:14px;font-weight:700;color:#003f8f;margin-top:2px">
      Sadar Bazar, Jagdishpur, Bhojpur
    </div>
    <div style="font-size:12px;margin-top:3px">
      Phone: +91-98358-07332 | Email: sudhirkumar6355@gmail.com
    </div>
  </div>

  <!-- QR + CERT -->
  <div style="text-align:right;font-size:12px">
    <% begin %>
      <%# Generate a short-lived signed URL that serves the invoice PDF without requiring login %>
      <% begin %>
        <% token = Rails.application.message_verifier(:invoices).generate({ order_id: @order.id, exp: 7.days.from_now.to_i }) %>
        <% qr_text = public_invoice_url(token: token, format: :pdf) %>
      <% rescue => _e %>
        <% qr_text = request.original_url rescue order_url(@order) %>
      <% end %>
      <% q = RQRCode::QRCode.new(qr_text) %>
      <div style="display:inline-block;padding:2px;border:1px solid #000;margin-bottom:6px;width:74px;height:74px;overflow:hidden">
        <%= raw q.as_svg(module_size: 1.1, standalone: true) %>
      </div>
    <% rescue %>
    <% end %>
    <div style="line-height:1.4">
      BIS Certified<br>
      100% Hallmarked
    </div>
  </div>
</div>

<!-- TITLE -->
<div style="text-align:center;font-weight:800;font-size:16px;margin:12px 0;text-decoration:underline">
  TAX INVOICE
</div>

<!-- BILL + INVOICE INFO -->
<div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:12px;font-size:12.5px">

  <div style="line-height:1.7">
    <strong>Bill To:</strong><br>
    <% if @order.customer.present? %>
      <strong><%= [@order.customer.first_name, @order.customer.last_name].join(' ') %></strong><br>
      <%= @order.customer.address %><br>
      Phone: <%= @order.customer.phone %>
    <% else %>
      Walk-in Customer
    <% end %>
  </div>

  <div style="line-height:1.7;text-align:right">
    <strong>Invoice No:</strong> <%= @order.invoice_number %><br>
    <strong>Date:</strong> <%= (@order.sale_date || Date.today).strftime('%d %b %Y') %><br>
    <strong>Order #:</strong> <%= @order.id %><br>
    <strong>Status:</strong> <%= @order.status.capitalize %>
  </div>
</div>

<!-- ITEMS TABLE -->
<table style="width:100%;border-collapse:collapse;table-layout:fixed">
<thead>
<tr style="background:#003f8f;color:#fff">
  <th style="border:1px solid #000;width:34px;text-align:center;color:#fff">Sr</th>
  <th style="border:1px solid #000;width:170px;text-align:left;color:#fff;padding-left:6px">Item</th>
  <th style="border:1px solid #000;width:70px;text-align:center;color:#fff">HUID</th>
  <th style="border:1px solid #000;width:60px;text-align:center;color:#fff">HSN</th>
  <th style="border:1px solid #000;width:45px;text-align:center;color:#fff">Qty</th>
  <th style="border:1px solid #000;width:55px;text-align:center;color:#fff;text-align:center">Gross wt(g)</th>
  <th style="border:1px solid #000;width:50px;text-align:center;color:#fff;text-align:center">Net wt(g)</th>
  <th style="border:1px solid #000;width:90px;text-align:right;color:#fff;padding-right:6px;text-align:center">Rate</th>
  <th style="border:1px solid #000;width:90px;text-align:right;color:#fff;padding-right:6px">Making (%)</th>
  <th style="border:1px solid #000;width:90px;text-align:right;color:#fff;padding-right:6px;text-align:center">Addl</th>
  <th style="border:1px solid #000;width:95px;text-align:right;color:#fff;padding-right:6px;text-align:center">Total</th>
</tr>
</thead>

<tbody>
<% subtotal = 0 %>

<% @order.line_items.each_with_index do |li, i| %>
  <%# compute per-gram rate: prefer stored line `rate`, else model per_gram_price or item's effective per-gram price, else fallback to price_cents/100.0 %>
  <% per_gram = if li.respond_to?(:per_gram_price) && li.per_gram_price.to_f > 0
                  li.per_gram_price.to_f
                elsif li.jewelry_item && li.jewelry_item.respond_to?(:effective_price_per_gram)
                  li.jewelry_item.effective_price_per_gram.to_f
                else
                  (li.price_cents.to_f / 100.0)
                end %>
  <% stored_rate = li.respond_to?(:rate) ? li.rate.to_f : 0.0 %>
  <% display_rate = (stored_rate && stored_rate > 0) ? stored_rate : per_gram %>
  <% qty = li.quantity.to_i %>
  <% net_w = li.net_weight.to_f %>
  <% add_per_item = li.respond_to?(:additional_charge) ? li.additional_charge.to_f : 0.0 %>
  <% line = (display_rate * net_w * qty) + (li.making_charge.to_f || 0.0) + (add_per_item * qty) %>
  <% base_material = (display_rate.to_f * net_w.to_f * qty.to_i) %>
  <% making_pct = base_material > 0 ? ((li.making_charge.to_f / base_material) * 100.0) : 0.0 %>
  <% subtotal += line %>
<tr>
  <td style="border:1px solid #000;text-align:center"><%= i+1 %></td>
  <td style="border:1px solid #000;padding-left:6px"><strong><%= li.jewelry_item&.name %></strong></td>
  <% huid_val = li.huid.present? ? li.huid : (li.jewelry_item.try(:sku).present? ? li.jewelry_item.try(:sku) : '-') %>
  <% hsn_val = li.hsn.present? ? li.hsn : (li.jewelry_item.try(:hsn).present? ? li.jewelry_item.try(:hsn) : '-') %>
  <td style="border:1px solid #000;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:70px">
    <span title="<%= h(huid_val) %>" style="line-height:1.1"><%= huid_val %></span>
  </td>
  <td style="border:1px solid #000;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:60px">
    <span title="<%= h(hsn_val) %>"><%= hsn_val %></span>
  </td>
  <td style="border:1px solid #000;text-align:center"><%= li.quantity %></td>
  <td style="border:1px solid #000;text-align:center"><%= '%.2f' % li.gross_weight.to_f %></td>
  <td style="border:1px solid #000;text-align:center"><%= '%.2f' % li.net_weight.to_f %></td>
  <%# show rate as per-gram price (prefer stored rate then per_gram) %>
  <td style="border:1px solid #000;text-align:right;padding-right:6px">₹<%= '%.2f' % display_rate %></td>
  <td style="border:1px solid #000;text-align:right;padding-right:6px"><%= number_with_precision(making_pct, precision: 2) %> %</td>
  <td style="border:1px solid #000;text-align:right;padding-right:6px">₹<%= '%.2f' % add_per_item %></td>
  <td style="border:1px solid #000;text-align:right;padding-right:6px;font-weight:700">₹<%= '%.2f' % line %></td>
</tr>
<% end %>
</tbody>
</table>

<!-- Paid via / payment method (styled) -->
<%# Precompute totals here so we can render amount-in-words next to the payment info %>
<% gross_total = subtotal %>
<% taxable_amount = gross_total - (@order.discount.to_f || 0.0) + (@order.charges.to_f || 0.0) %>
<% cgst_rate = 1.5; igst_rate = 1.5 %>
<% cgst_amt = taxable_amount * (cgst_rate / 100.0) %>
<% igst_amt = taxable_amount * (igst_rate / 100.0) %>
<% total = taxable_amount + cgst_amt + igst_amt %>
<% rounded_total = total.round(0) %>

<div style="display:flex;justify-content:flex-start;margin-top:8px;font-size:13px;gap:24px;align-items:flex-start">
  <div style="border:none;padding:6px 10px;min-width:200px;text-align:left;background:#fafafa">
    <div style="font-size:11px;color:#555;line-height:1">Paid via</div>
    <div style="font-weight:700;font-size:14px;line-height:1.1;color:#000">
      <% if @order.respond_to?(:payment_method) && @order.payment_method.present? %>
        <%= @order.payment_method %>
      <% else %>
        Not specified
      <% end %>
    </div>
  </div>

  <div style="min-width:360px;padding:6px 10px">
    <strong>Amount (in words):</strong>
    <div style="margin-top:6px;font-weight:700;text-transform:capitalize"><%= number_to_words(rounded_total) %></div>
  </div>
</div>

<!-- Payments list (invoices per payment) -->
<% if @order.payments.any? %>
  <div style="margin-top:18px;border-top:1px dashed #ddd;padding-top:12px;font-size:13px">
    <div style="font-weight:700;margin-bottom:8px">Payments & Receipts</div>
    <table style="width:100%;border-collapse:collapse;font-size:13px">
      <thead>
        <tr style="background:#fafafa"><th style="text-align:left;padding:8px">Date</th><th style="text-align:left">Method</th><th style="text-align:right;padding-right:8px">Amount</th><th style="text-align:left;padding-left:8px">Receipt</th></tr>
      </thead>
      <tbody>
        <% @order.payments.order(created_at: :asc).each do |pm| %>
          <tr>
            <td style="padding:8px"><%= pm.created_at.strftime('%d %b %Y %I:%M %p') %></td>
            <td><%= pm.payment_method.presence || '-' %></td>
            <td style="text-align:right;padding-right:8px">₹<%= '%.2f' % (pm.amount_cents.to_f/100.0) %></td>
            <td style="padding-left:8px">
              <% if pm.receipt_number.present? %>
                <%= link_to pm.receipt_number, invoice_payment_path(pm), target: '_blank' %>
              <% else %>
                <%= link_to "Receipt ##{pm.id}", invoice_payment_path(pm), target: '_blank' %>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
<% end %>

</div>

<!-- ================= SUMMARY ================= -->
<%# Precompute totals so we can show paid/remaining on the left without changing layout %>
<% gross_total = subtotal %>
<% taxable_amount = gross_total - (@order.discount.to_f || 0.0) + (@order.charges.to_f || 0.0) %>
<%# Always compute CGST/SGST from the taxable amount here to match the order show page calculations %>
<% cgst_rate = 1.5 %>
<% igst_rate = 1.5 %>
<% cgst_amt = taxable_amount * (cgst_rate / 100.0) %>
<% igst_amt = taxable_amount * (igst_rate / 100.0) %>
<% total = taxable_amount + cgst_amt + igst_amt %>
<% rounded_total = total.round(0) %>
<% payments_cents = @order.payments.sum(:amount_cents).to_i %>
<% paid_total = payments_cents.to_f / 100.0 %>
<% total_payable_cents = (total * 100.0).round %>
<% remaining_cents = [total_payable_cents - payments_cents, 0].max %>
<% remaining = remaining_cents.to_f / 100.0 %>

<div style="display:grid;grid-template-columns:1fr 360px;gap:16px;margin-top:16px;font-size:12.5px">

  <!-- Left: show Paid / Remaining (left aligned) -->
  <div style="font-size:13px;line-height:1.4;margin-top:12px">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>Total Paid (जमा राशि)</strong></div>
      <div style="font-weight:700;text-align:right">₹<%= '%.2f' % paid_total %></div>
    </div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
      <div><strong>Remaining Amount (बाकी)</strong></div>
      <div style="font-weight:700;text-align:right;color:#b91c1c">₹<%= '%.2f' % remaining %></div>
    </div>
  </div>

  <!-- Amount Summary -->
  <div>
    <table style="width:100%;border-collapse:collapse">
      <tr>
        <td style="border:1px solid #000;padding:6px">Gross Total</td>
        <td style="border:1px solid #000;padding:6px;text-align:right">₹<%= '%.2f' % gross_total %></td>
      </tr>

      <tr>
        <td style="border:1px solid #000;padding:6px">Discount</td>
        <td style="border:1px solid #000;padding:6px;text-align:right">₹<%= '%.2f' % (@order.discount.to_f || 0.0) %></td>
      </tr>

      <tr>
        <td style="border:1px solid #000;padding:6px">Taxable Amount</td>
        <td style="border:1px solid #000;padding:6px;text-align:right">₹<%= '%.2f' % taxable_amount %></td>
      </tr>

      <tr>
        <td style="border:1px solid #000;padding:6px">CGST <%= cgst_rate %>%</td>
        <td style="border:1px solid #000;padding:6px;text-align:right">₹<%= '%.2f' % cgst_amt %></td>
      </tr>

      <tr>
        <td style="border:1px solid #000;padding:6px">SGST <%= igst_rate %>%</td>
        <td style="border:1px solid #000;padding:6px;text-align:right">₹<%= '%.2f' % igst_amt %></td>
      </tr>

      <tr>
        <td style="border:1px solid #000;padding:6px;font-weight:700">Total</td>
        <td style="border:1px solid #000;padding:6px;text-align:right;font-weight:700">₹<%= '%.2f' % total %></td>
      </tr>

      <tr>
        <td style="border:1px solid #000;padding:6px">Round Off</td>
        <td style="border:1px solid #000;padding:6px;text-align:right">₹<%= '%.2f' % (rounded_total - total) %></td>
      </tr>

      <tr>
        <td style="border:1px solid #000;padding:7px;font-size:14px;font-weight:800">Net Amount</td>
        <td style="border:1px solid #000;padding:7px;text-align:right;font-size:14px;font-weight:800">₹<%= '%.2f' % rounded_total %></td>
      </tr>
    </table>
  </div>
</div>



<!-- FOOTER: signatures + governing law (anchored to bottom of invoice) -->
  <div style="margin-top:auto;padding-top:30px;padding-bottom:18px;border-top:1px solid #e6edf5;font-size:12px;color:#111827;line-height:1.6">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px">
        <div>
          Customer Signature
          <div style="margin-top:30px;border-top:1px solid #000;width:220px"></div>
        </div>
        <div style="text-align:right">
          For <%= app_name %>
          <div style="margin-top:30px;border-top:1px solid #000;width:220px;margin-left:auto"></div>
          Authorized Signatory
        </div>
      </div>

      <div style="font-size:11px;color:#4b5563;line-height:1.6;margin-top:12px">
        <!-- DISCLAIMER: brief note about breakage -->
        <div style="margin-top:12px;font-size:12px;color:#6b7280;line-height:1.4">
          <strong>Note:</strong>
          <ol style="margin:6px 0 0 18px;padding:0">
            <li>No guarantee is provided against breakage. Please handle items with care.</li>
            <li>The deal will be finalized only after 75% of the money has been deposited</li>
          </ol>
        </div>
        <strong style="display:block;margin-top:10px">Governing Law & Jurisdiction:</strong>
        This invoice shall be governed by and construed in accordance with the laws of India. Any dispute, claim or proceeding arising out of or in connection with this invoice shall be subject to the exclusive jurisdiction of the courts at Jagdishpur, Bihar, India.
      </div>
    </div>

  </div> <!-- .invoice-box -->

</div> <!-- #print-area -->

</body>
</html>
