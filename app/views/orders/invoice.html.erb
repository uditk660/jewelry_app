<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Tax Invoice</title>

  <style>
    body {
      margin: 0;
      padding: 0;
      background: #f5f5f5;
      font-family: Arial, Helvetica, sans-serif;
    }

    .invoice-box {
      min-height: calc(297mm - 24mm);
      display: flex;
      flex-direction: column;
    }

    .invoice-body {
      flex: 1;
    }

    @media print {
      @page {
        size: A4;
        margin: 0;
      }

      .invoice-box {
        border: none !important;
      }

      body {
        background: #fff !important;
      }

      body * {
        visibility: hidden;
      }

      #print-area,
      #print-area * {
        visibility: visible;
      }

      #print-area {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
      }

      .no-print {
        display: none !important;
      }

      table, tr, td, th {
        page-break-inside: avoid !important;
      }
    }
  </style>
</head>

<body>

<!-- PRINT BUTTON -->
<div class="no-print" style="width:960px;margin:12px auto 0;text-align:right">
  <button onclick="window.print()"
    style="padding:8px 20px;border:1px solid #000;background:#fff;cursor:pointer;font-size:13px">
    Print Invoice
  </button>
</div>

<div id="print-area">

<div class="invoice-box"
  style="width:960px;margin:12px auto;background:#fff;border:1.5px solid #000;padding:20px 14px;font-size:13px;color:#000;display:flex;flex-direction:column;min-height:calc(297mm - 40mm)">

<div class="invoice-body">

<!-- ================= HEADER ================= -->
<div style="display:grid;
            grid-template-columns:220px 1fr 160px;
            align-items:center;
            border-bottom:1.8px solid #000;
            padding-bottom:12px">

  <!-- GST -->
  <div style="font-size:12px;line-height:1.7">
    <strong>GSTIN:</strong><br>
    10CMOPK8720K1ZV<br>
   <strong>A/C:</strong> 32606206871<br>
   <strong>IFSC:</strong> SBIN0010769<br>
   <strong>B Name:</strong> SUDHIR KUMAR
  </div>

  <!-- CENTER BRAND -->
  <div style="text-align:center">
    <% app_name = "Rajesh Alankar Mandir" %>
    <div style="font-size:28px;font-weight:900;color:#b30000;letter-spacing:1.2px">
      <%= app_name %>
    </div>
    <div style="font-size:14px;font-weight:700;color:#003f8f;margin-top:2px">
      Sadar Bazar, Jagdishpur, Bhojpur
    </div>
    <div style="font-size:12px;margin-top:3px">
      Phone: +91-98358-07332 | Email: sudhirkumar6355@gmail.com
    </div>
  </div>

  <!-- QR + CERT -->
  <div style="text-align:right;font-size:12px">
    <% begin %>
      <% qr_text = request.original_url rescue order_url(@order) %>
      <% q = RQRCode::QRCode.new(qr_text) %>
      <div style="display:inline-block;padding:4px;border:1px solid #000;margin-bottom:6px">
        <%= raw q.as_svg(module_size: 2, standalone: true) %>
      </div>
    <% rescue %>
    <% end %>
    <div style="line-height:1.4">
      BIS Certified<br>
      100% Hallmarked
    </div>
  </div>
</div>

<!-- TITLE -->
<div style="text-align:center;font-weight:800;font-size:16px;margin:12px 0;text-decoration:underline">
  TAX INVOICE
</div>

<!-- BILL + INVOICE INFO -->
<div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:12px;font-size:12.5px">

  <div style="line-height:1.7">
    <strong>Bill To:</strong><br>
    <% if @order.customer.present? %>
      <strong><%= [@order.customer.first_name, @order.customer.last_name].join(' ') %></strong><br>
      <%= @order.customer.address %><br>
      Phone: <%= @order.customer.phone %>
    <% else %>
      Walk-in Customer
    <% end %>
  </div>

  <div style="line-height:1.7;text-align:right">
    <strong>Invoice No:</strong> <%= @order.invoice_number %><br>
    <strong>Date:</strong> <%= (@order.sale_date || Date.today).strftime('%d %b %Y') %><br>
    <strong>Order #:</strong> <%= @order.id %><br>
    <strong>Status:</strong> <%= @order.status.capitalize %>
  </div>
</div>

<!-- ITEMS TABLE -->
<table style="width:100%;border-collapse:collapse;table-layout:fixed">
<thead>
<tr style="background:#f3f3f3">
  <th style="border:1px solid #000;width:34px">Sr</th>
  <th style="border:1px solid #000;width:170px;text-align:left">Item</th>
  <th style="border:1px solid #000;width:70px">HUID</th>
  <th style="border:1px solid #000;width:60px">HSN</th>
  <th style="border:1px solid #000;width:45px">Qty</th>
  <th style="border:1px solid #000;width:45px">Gross</th>
  <th style="border:1px solid #000;width:45px">Net</th>
  <th style="border:1px solid #000;width:90px">Rate</th>
  <th style="border:1px solid #000;width:90px">Making</th>
  <th style="border:1px solid #000;width:90px">Addl</th>
  <th style="border:1px solid #000;width:95px">Total</th>
</tr>
</thead>

<tbody>
<% subtotal = 0 %>

<% @order.line_items.each_with_index do |li, i| %>
  <%# prefer model helper line_amount (per_gram * net * qty + making), fall back to previous formula if absent %>
  <% line = if li.respond_to?(:line_amount)
               li.line_amount.to_f
             else
               (li.net_weight.to_f * li.quantity.to_i * (li.price_cents.to_f / 100.0)) + li.making_charge.to_f
             end %>
  <% subtotal += line %>
<tr>
  <td style="border:1px solid #000;text-align:center"><%= i+1 %></td>
  <td style="border:1px solid #000;padding-left:6px"><strong><%= li.jewelry_item&.name %></strong></td>
  <% huid_val = li.huid.present? ? li.huid : (li.jewelry_item.try(:sku).present? ? li.jewelry_item.try(:sku) : '-') %>
  <% hsn_val = li.hsn.present? ? li.hsn : (li.jewelry_item.try(:hsn).present? ? li.jewelry_item.try(:hsn) : '-') %>
  <td style="border:1px solid #000;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:70px">
    <span title="<%= h(huid_val) %>" style="font-size:8px;line-height:1.1"><%= huid_val %></span>
  </td>
  <td style="border:1px solid #000;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:60px">
    <span title="<%= h(hsn_val) %>"><%= hsn_val %></span>
  </td>
  <td style="border:1px solid #000;text-align:center"><%= li.quantity %></td>
  <td style="border:1px solid #000;text-align:center"><%= li.gross_weight %></td>
  <td style="border:1px solid #000;text-align:center"><%= li.net_weight %></td>
  <%# show rate as per-gram price (model exposes per_gram_price) %>
  <td style="border:1px solid #000;text-align:right;padding-right:6px">₹<%= '%.2f' % (li.respond_to?(:per_gram_price) ? li.per_gram_price.to_f : (li.price_cents.to_f/100.0)) %></td>
  <td style="border:1px solid #000;text-align:right;padding-right:6px">₹<%= '%.2f' % li.making_charge %></td>
  <td style="border:1px solid #000;text-align:right;padding-right:6px">₹<%= '%.2f' % (li.additional_charge.to_f) %></td>
  <td style="border:1px solid #000;text-align:right;padding-right:6px;font-weight:700">₹<%= '%.2f' % line %></td>
</tr>
<% end %>
</tbody>
</table>

<!-- Paid via / payment method (styled) -->
<div style="display:flex;justify-content:flex-start;margin-top:8px;font-size:13px">
  <div style="border:none;padding:6px 10px;min-width:200px;text-align:left;background:#fafafa">
    <div style="font-size:11px;color:#555;line-height:1">Paid via</div>
    <div style="font-weight:700;font-size:14px;line-height:1.1;color:#000">
      <% if @order.respond_to?(:payment_method) && @order.payment_method.present? %>
        <%= @order.payment_method %>
      <% else %>
        Not specified
      <% end %>
    </div>
  </div>
</div>

<!-- Payments list (invoices per payment) -->
<% if @order.payments.any? %>
  <div style="margin-top:18px;border-top:1px dashed #ddd;padding-top:12px;font-size:13px">
    <div style="font-weight:700;margin-bottom:8px">Payments & Receipts</div>
    <table style="width:100%;border-collapse:collapse;font-size:13px">
      <thead>
        <tr style="background:#fafafa"><th style="text-align:left;padding:8px">Date</th><th style="text-align:left">Method</th><th style="text-align:right;padding-right:8px">Amount</th><th style="text-align:left;padding-left:8px">Receipt</th></tr>
      </thead>
      <tbody>
        <% @order.payments.order(created_at: :asc).each do |pm| %>
          <tr>
            <td style="padding:8px"><%= pm.created_at.strftime('%d %b %Y %I:%M %p') %></td>
            <td><%= pm.payment_method.presence || '-' %></td>
            <td style="text-align:right;padding-right:8px">₹<%= '%.2f' % (pm.amount_cents.to_f/100.0) %></td>
            <td style="padding-left:8px">
              <% if pm.receipt_number.present? %>
                <%= link_to pm.receipt_number, invoice_payment_path(pm), target: '_blank' %>
              <% else %>
                <%= link_to "Receipt ##{pm.id}", invoice_payment_path(pm), target: '_blank' %>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
<% end %>

</div>

<!-- ================= SUMMARY ================= -->
<%# Precompute totals so we can show paid/remaining on the left without changing layout %>
<% gross_total = subtotal %>
<% taxable_amount = gross_total - (@order.discount.to_f || 0.0) + (@order.charges.to_f || 0.0) %>
<% if @order.respond_to?(:cgst_cents) && @order.cgst_cents.to_i > 0 %>
  <% cgst_amt = (@order.cgst_cents.to_f / 100.0) %>
  <% cgst_rate = @order.respond_to?(:cgst_rate) ? @order.cgst_rate.to_f : (@order.respond_to?(:cgst_rate_or_default) ? @order.cgst_rate_or_default : 1.5) %>
<% else %>
  <% cgst_rate = @order.respond_to?(:cgst_rate_or_default) ? @order.cgst_rate_or_default : 1.5 %>
  <% cgst_amt = taxable_amount * (cgst_rate / 100.0) %>
<% end %>
<% if @order.respond_to?(:igst_cents) && @order.igst_cents.to_i > 0 %>
  <% igst_amt = (@order.igst_cents.to_f / 100.0) %>
  <% igst_rate = @order.respond_to?(:igst_rate) ? @order.igst_rate.to_f : (@order.respond_to?(:igst_rate_or_default) ? @order.igst_rate_or_default : 1.5) %>
<% else %>
  <% igst_rate = @order.respond_to?(:igst_rate_or_default) ? @order.igst_rate_or_default : 1.5 %>
  <% igst_amt = taxable_amount * (igst_rate / 100.0) %>
<% end %>
<% total = taxable_amount + cgst_amt + igst_amt %>
<% rounded_total = total.round(0) %>
<% paid_total = @order.payments.sum(:amount_cents).to_f/100.0 %>
<% remaining = [0, (rounded_total - paid_total)].max %>

<div style="display:grid;grid-template-columns:1fr 360px;gap:16px;margin-top:16px;font-size:12.5px">

  <!-- Left: show Paid / Remaining (left aligned) -->
  <div style="font-size:13px;line-height:1.4;margin-top:12px">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>Total Paid</strong></div>
      <div style="font-weight:700;text-align:right">₹<%= '%.2f' % paid_total %></div>
    </div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
      <div><strong>Remaining Amount</strong></div>
      <div style="font-weight:700;text-align:right;color:#b91c1c">₹<%= '%.2f' % remaining %></div>
    </div>
  </div>

  <!-- Amount Summary -->
  <div>
    <table style="width:100%;border-collapse:collapse">
      <tr>
        <td style="border:1px solid #000;padding:6px">Gross Total</td>
        <td style="border:1px solid #000;padding:6px;text-align:right">₹<%= '%.2f' % gross_total %></td>
      </tr>

      <tr>
        <td style="border:1px solid #000;padding:6px">Discount</td>
        <td style="border:1px solid #000;padding:6px;text-align:right">₹<%= '%.2f' % (@order.discount.to_f || 0.0) %></td>
      </tr>

      <tr>
        <td style="border:1px solid #000;padding:6px">Taxable Amount</td>
        <td style="border:1px solid #000;padding:6px;text-align:right">₹<%= '%.2f' % taxable_amount %></td>
      </tr>

      <tr>
        <td style="border:1px solid #000;padding:6px">CGST <%= cgst_rate %>%</td>
        <td style="border:1px solid #000;padding:6px;text-align:right">₹<%= '%.2f' % cgst_amt %></td>
      </tr>

      <tr>
        <td style="border:1px solid #000;padding:6px">SGST <%= igst_rate %>%</td>
        <td style="border:1px solid #000;padding:6px;text-align:right">₹<%= '%.2f' % igst_amt %></td>
      </tr>

      <tr>
        <td style="border:1px solid #000;padding:6px;font-weight:700">Total</td>
        <td style="border:1px solid #000;padding:6px;text-align:right;font-weight:700">₹<%= '%.2f' % total %></td>
      </tr>

      <tr>
        <td style="border:1px solid #000;padding:6px">Round Off</td>
        <td style="border:1px solid #000;padding:6px;text-align:right">₹<%= '%.2f' % (rounded_total - total) %></td>
      </tr>

      <tr>
        <td style="border:1px solid #000;padding:7px;font-size:14px;font-weight:800">Net Amount</td>
        <td style="border:1px solid #000;padding:7px;text-align:right;font-size:14px;font-weight:800">₹<%= '%.2f' % rounded_total %></td>
      </tr>
    </table>
  </div>
</div>



<!-- FOOTER: signatures + governing law (anchored to bottom of invoice) -->
    <div style="margin-top:auto;padding-top:18px;border-top:1px solid #e6edf5;font-size:12px;color:#111827">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px">
        <div>
          Customer Signature
          <div style="margin-top:30px;border-top:1px solid #000;width:220px"></div>
        </div>
        <div style="text-align:right">
          For <%= app_name %>
          <div style="margin-top:30px;border-top:1px solid #000;width:220px;margin-left:auto"></div>
          Authorized Signatory
        </div>
      </div>

      <div style="font-size:11px;color:#4b5563;line-height:1.4;margin-top:6px">
        <strong>Governing Law & Jurisdiction:</strong>
        This invoice shall be governed by and construed in accordance with the laws of India. Any dispute, claim or proceeding arising out of or in connection with this invoice shall be subject to the exclusive jurisdiction of the courts at Jagdishpur, Bihar, India.
      </div>
    </div>

  </div> <!-- .invoice-box -->

</div> <!-- #print-area -->

</body>
</html>
