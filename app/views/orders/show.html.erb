<div class="order-show">

  <!-- ===== HEADER ===== -->
  <header class="order-header">
    <div>
      <h1>Sales Order <span>#<%= @order.id %></span></h1>
      <p>
        Status:
        <strong class="status <%= @order.status %>">
          <%= @order.status.capitalize %>
        </strong>
        · Created <%= @order.created_at.strftime('%d %b %Y, %I:%M %p') %>
      </p>
      <% if @order.customer.present? %>
        <p class="customer-info" style="margin-top:6px;color:#374151;font-size:0.95rem">
          <strong><%= link_to @order.customer.full_name, customer_path(@order.customer), class: 'customer-link' %></strong>
          <% if @order.customer.phone.present? %>
            &nbsp;·&nbsp;<span class="muted"><%= @order.customer.phone %></span>
          <% end %>
        </p>
      <% end %>
    </div>

    <div class="header-actions">
      <%= link_to 'Back to Orders', orders_path, class: 'btn btn-secondary' %>
    </div>
  </header>

  <!-- ===== ITEMS ===== -->
  <section class="card">
    <h2>Order Items</h2>

    <table class="items-table">
      <thead>
        <tr>
          <th>Item</th>
          <th>HUID</th>
          <th>HSN</th>
          <th class="center">Qty</th>
          <th class="right">Gross (g)</th>
          <th class="right">Net (g)</th>
          <th class="right">Rate (₹)</th>
          <th class="right">Making (₹)</th>
          <th class="right">Addl (₹)</th>
          <th class="right">Line Total (₹)</th>
        </tr>
      </thead>
      <tbody>
        <% subtotal_calc = 0.0 %>
        <% @order.line_items.each do |li| %>
            <% per_gram = (li.jewelry_item.respond_to?(:effective_price_per_gram) ? li.jewelry_item.effective_price_per_gram.to_f : nil) %>
            <% stored_rate = li.respond_to?(:rate) ? li.rate.to_f : 0.0 %>
            <% net_w = li.net_weight.to_f %>
            <% qty = li.quantity.to_i %>
            <% display_rate = (stored_rate && stored_rate > 0) ? stored_rate : (per_gram || 0.0) %>
            <% base_amount = (display_rate * net_w * qty) %>
            <% add_per_item = li.respond_to?(:additional_charge) ? li.additional_charge.to_f : 0.0 %>
            <% add_total = add_per_item * qty %>
            <% line_total = base_amount + li.making_charge.to_f + add_total %>
          <% subtotal_calc += line_total %>
          <tr>
            <td class="item-name"><%= li.jewelry_item.name %></td>
            <td><%= li.huid.presence || '-' %></td>
            <td><%= li.hsn.presence || '-' %></td>
            <td class="center"><%= li.quantity %></td>
            <td class="right"><%= '%.2f' % li.gross_weight.to_f %></td>
            <td class="right"><%= '%.2f' % li.net_weight.to_f %></td>
            <td class="right"><%= '%.2f' % display_rate %></td>
            <td class="right"><%= '%.2f' % li.making_charge.to_f %></td>
            <td class="right"><%= '%.2f' % add_per_item %></td>
            <td class="right total-cell">
              <%= '%.2f' % line_total %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </section>

  <!-- ===== SUMMARY + PAYMENT ===== -->
  <div class="layout-two">

    <!-- SUMMARY -->
    <aside class="summary-card">
      <h3>Order Summary</h3>

      <div class="summary-row">
        <span>Subtotal</span>
        <span>₹<%= '%.2f' % subtotal_calc %></span>
      </div>

      <div class="summary-row muted">
        <span>Discount</span>
        <span id="discount-display">₹<%= '%.2f' % @order.discount.to_f %></span>
      </div>

      <div class="summary-row muted">
        <span>Making Charges</span>
        <span>₹<%= '%.2f' % @order.charges.to_f %></span>
      </div>

      <hr>

      <div class="summary-row emphasis">
        <span>Taxable Amount</span>
        <span id="taxable-display">
          ₹<%= '%.2f' % (subtotal_calc - @order.discount.to_f + @order.charges.to_f) %>
        </span>
      </div>

      <div class="summary-row">
        <span>CGST (1.5%)</span>
        <span id="cgst-amount">₹0.00</span>
      </div>

      <div class="summary-row">
        <span>IGST (1.5%)</span>
        <span id="igst-amount">₹0.00</span>
      </div>

      <div class="summary-total">
        <span>Total Payable</span>
        <% taxable_calc = subtotal_calc - @order.discount.to_f + @order.charges.to_f %>
  <% cgst_amt = taxable_calc * (1.5 / 100.0) %>
  <% igst_amt = taxable_calc * (1.5 / 100.0) %>
        <strong id="total-display">
          ₹<%= '%.2f' % (taxable_calc + cgst_amt + igst_amt) %>
        </strong>
      </div>
      <%# compute remaining due from total_payable minus recorded payments (safer than trusting a stored remaining_cents) %>
      <% total_payable_cents = ((taxable_calc + cgst_amt + igst_amt) * 100.0).round %>
      <% payments_cents = (@order.respond_to?(:payments) ? @order.payments.sum(:amount_cents).to_i : 0) %>
      <% remaining_cents_display = [total_payable_cents - payments_cents, 0].max %>
      <% if remaining_cents_display > 0 %>
        <div class="summary-row muted">
          <span>Remaining Due</span>
          <span>₹<%= '%.2f' % (remaining_cents_display.to_f / 100.0) %></span>
        </div>
      <% end %>
    </aside>

    <!-- PAYMENT -->
    <% if @order.status == 'pending' %>
      <section id="charge-form" class="payment-card">
        <h3>Record Payment</h3>
        <p class="hint">
          Finalize the order by confirming tax, discount, and charges.
        </p>

        <form method="post"
              action="<%= record_payment_order_path(@order) %>">
          <input type="hidden"
                 name="authenticity_token"
                 value="<%= form_authenticity_token %>">

          <div class="form-grid">
            <div>
              <label>Discount(If any ?)</label>
              <div style="display:flex;align-items:center;gap:8px">
                <select id="discount-type" style="width:150px">
                  <option value="amount">Amount</option>
                  <option value="percent">Percent</option>
                </select>
                <input id="discount_input" type="number" step="0.01" style="width:200px"
                       value="<%= @order.discount.to_f %>">
              </div>
              <div id="discount-error" style="color:#a00; font-size:12px; display:none; margin-top:4px">Discount cannot exceed subtotal</div>
            </div>

            <div>
              <label><span style="color:#a00;margin-right:6px">*</span>Paid via</label>
                <select name="payment_method" id="payment_method_input" style="width:220px" required aria-required="true">
                <option value="">-- Select --</option>
                <option value="Cash" <%= 'selected' if (@order.respond_to?(:payment_method) && @order.payment_method.to_s == 'Cash') %>>Cash</option>
                <option value="Card" <%= 'selected' if (@order.respond_to?(:payment_method) && @order.payment_method.to_s == 'Card') %>>Card</option>
                <option value="Online" <%= 'selected' if (@order.respond_to?(:payment_method) && @order.payment_method.to_s == 'Online') %>>Online</option>
                <option value="PhonePe" <%= 'selected' if (@order.respond_to?(:payment_method) && @order.payment_method.to_s == 'PhonePe') %>>PhonePe</option>
                <option value="Paytm" <%= 'selected' if (@order.respond_to?(:payment_method) && @order.payment_method.to_s == 'Paytm') %>>Paytm</option>
                <option value="GPay" <%= 'selected' if (@order.respond_to?(:payment_method) && @order.payment_method.to_s == 'GPay') %>>GPay</option>
                <option value="Others" <%= 'selected' if (@order.respond_to?(:payment_method) && @order.payment_method.to_s == 'Others') %>>Others</option>
              </select>
              <div id="payment-error" style="color:#a00; font-size:12px; display:<%= @order.errors[:payment_method].present? ? 'block' : 'none' %>; margin-top:4px">
                <%= (@order.errors[:payment_method].first if @order.errors[:payment_method].present?) || 'Please select a payment method' %>
              </div>
            </div>

            <div>
              <label>Payment Amount</label>
              <%# compute remaining amount in cents from total_payable minus payments (prefer this authoritative calculation) %>
              <% total_payable_cents = ((taxable_calc + cgst_amt + igst_amt) * 100.0).round %>
              <% payments_cents = (@order.respond_to?(:payments) ? @order.payments.sum(:amount_cents).to_i : 0) %>
              <% remaining = [total_payable_cents - payments_cents, 0].max %>
              <input type="number" name="payment_amount" id="payment_amount_input" step="0.01" min="0" max="<%= (remaining.to_f/100.0).round(2) %>" style="width:200px" value="<%= (remaining.to_f/100.0).round(2) %>">
              <div id="payment-amount-hint" style="font-size:12px;color:#666;margin-top:4px">Enter full or partial amount. Remaining will update after recording payment.</div>
            </div>

            <%# submit fixed tax rates as hidden fields so controller receives them %>
            <input type="hidden" name="cgst_rate" id="cgst_rate_show" value="1.5">
            <input type="hidden" name="igst_rate" id="igst_rate_show" value="1.5">
            <%# hidden numeric discount (amount in rupees) sent to server %>
            <input type="hidden" name="discount" id="discount_hidden" value="<%= @order.discount.to_f %>">
          </div>

          <div class="form-actions">
            <button id="record-payment-btn" class="btn btn-primary">
              Record Payment & Print Invoice
            </button>
          </div>
        </form>
      </section>
    <% end %>

    <%# Payments history (moved below layout for full-width display) %>

  </div>
  </div>

      <%# Payments history (show even when order paid) %>
      <% if @order.payments.any? %>
        <style>
          .payments-card.full-width-card{ width:100%; box-shadow:0 6px 18px rgba(16,24,40,0.06); border-radius:8px; padding:14px 18px; margin-top:16px; background:#fff; }
          .payments-card.full-width-card h3{ margin:0 0 8px 0; font-size:1.05rem; color:#0f172a; }
          .payments-card.full-width-card table.items-table{ width:100%; border-collapse:collapse; font-size:0.95rem; }
          .payments-card.full-width-card table.items-table thead th{ background:#f8fafc; padding:10px 12px; text-align:left; color:#374151; font-weight:600; border-bottom:1px solid #e6eef8; }
          .payments-card.full-width-card table.items-table tbody td{ padding:10px 12px; border-bottom:1px solid #f1f5f9; color:#111827; }
          .payments-card.full-width-card table.items-table tbody tr:last-child td{ border-bottom:none; }
          .payments-card.full-width-card .right{ text-align:right; }
          .payments-card.full-width-card .muted{ color:#6b7280; font-size:0.9rem }
        </style>
        <section class="card payments-card full-width-card">
          <h3>Payments History</h3>
          <table class="items-table payments-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Method</th>
                <th class="right">Amount (₹)</th>
                <th>Note</th>
              </tr>
            </thead>
            <tbody>
              <% @order.payments.order(created_at: :asc).each do |pmnt| %>
                <tr>
                  <td><%= pmnt.created_at.strftime('%d %b %Y %I:%M %p') %></td>
                  <td><%= pmnt.payment_method.presence || '-' %></td>
                  <td class="right"><%= '%.2f' % (pmnt.amount_cents.to_f/100.0) %></td>
                    <td>
                      <% if pmnt.receipt_number.present? %>
                        <%= link_to pmnt.receipt_number, invoice_payment_path(pmnt), target: '_blank' %>
                      <% else %>
                        <%= pmnt.note.presence || '-' %>
                      <% end %>
                    </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </section>
      <% end %>

  <!-- JS UNCHANGED -->
<script>
  function money(v){ return '\u20B9' + v.toFixed(2); }
  const subtotal = <%= subtotal_calc %>;
  const charges = <%= @order.charges.to_f %>;
  const initialPaymentsCents = <%= (@order.respond_to?(:payments) ? @order.payments.sum(:amount_cents).to_i : 0) %>;
  const hasRecordedRemaining = <%= (@order.respond_to?(:remaining_cents) && @order.remaining_cents.to_i > 0) ? 'true' : 'false' %>;

  function update(){
    const type = document.getElementById('discount-type').value;
    let raw = parseFloat(document.getElementById('discount_input').value || 0) || 0;
    let discountAmt = 0;
    if(type === 'percent'){
      discountAmt = subtotal * raw / 100.0;
    } else {
      discountAmt = raw;
    }
    // clamp discount to subtotal
    const discountErrorEl = document.getElementById('discount-error');
    if(discountAmt > subtotal){
      if(discountErrorEl) discountErrorEl.style.display = 'block';
      discountAmt = subtotal;
    } else {
      if(discountErrorEl) discountErrorEl.style.display = 'none';
    }
    document.getElementById('discount-display').textContent = money(discountAmt);
    const taxable = subtotal - discountAmt + charges;
    const cgstRate = 1.5;
    const igstRate = 1.5;
    const cgst = taxable * (cgstRate/100);
    const igst = taxable * (igstRate/100);
    document.getElementById('cgst-amount').textContent = money(cgst);
    document.getElementById('igst-amount').textContent = money(igst);
    document.getElementById('taxable-display').textContent = money(taxable);
    document.getElementById('total-display').textContent = money(taxable + cgst + igst);
    // if there were no prior payments and no stored remaining, keep payment input synced to total payable
    try{
      const payInput = document.getElementById('payment_amount_input');
      if(payInput && initialPaymentsCents === 0 && !hasRecordedRemaining){
        const totalPayable = (taxable + cgst + igst);
        payInput.value = totalPayable.toFixed(2);
        payInput.max = totalPayable.toFixed(2);
      }
    }catch(e){}
    // update hidden discount in rupees for server submission
    const discountHidden = document.getElementById('discount_hidden');
    if(discountHidden) discountHidden.value = discountAmt.toFixed(2);
  }
  // wire inputs so changes reflect on the summary card
  const cgstInput = document.getElementById('cgst_rate_show');
  const igstInput = document.getElementById('igst_rate_show');
  const discountInput = document.getElementById('discount_input');
  if(cgstInput) cgstInput.addEventListener('input', update);
  if(igstInput) igstInput.addEventListener('input', update);
  if(discountInput) discountInput.addEventListener('input', update);
  const discountTypeEl = document.getElementById('discount-type');
  if(discountTypeEl) discountTypeEl.addEventListener('change', update);
  update();

  // Disable payment submit unless a payment method is selected and amount > 0
  (function(){
    const pm = document.getElementById('payment_method_input');
    const btn = document.getElementById('record-payment-btn');
    const amt = document.getElementById('payment_amount_input');
    if(!pm || !btn || !amt) return;
    function toggle(){ 
      const val = parseFloat(amt.value || 0);
      const max = parseFloat(amt.getAttribute('max') || '0');
      const over = (max > 0 && val > max);
      btn.disabled = (pm.value === '' || pm.value == null) || (val <= 0) || over; 
      // show hint when over
      const hint = document.getElementById('payment-amount-hint');
      if(hint) hint.style.color = over ? '#a00' : '#666';
    }
    pm.addEventListener('change', toggle);
    amt.addEventListener('input', toggle);
    // initial state
    toggle();
  })();
</script>
