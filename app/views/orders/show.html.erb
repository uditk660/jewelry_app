<div class="order-show">

  <!-- ===== HEADER ===== -->
  <header class="order-header">
    <div>
      <h1>Sales Order <span>#<%= @order.id %></span></h1>
      <p>
        Status:
        <strong class="status <%= @order.status %>">
          <%= @order.status.capitalize %>
        </strong>
        · Created <%= @order.created_at.strftime('%d %b %Y, %I:%M %p') %>
      </p>
    </div>

    <div class="header-actions">
      <%= link_to 'Back to Orders', orders_path, class: 'btn btn-secondary' %>
      <% if @order.status == 'pending' %>
        <%= link_to 'Record Payment', '#charge-form', class: 'btn btn-primary' %>
      <% end %>
    </div>
  </header>

  <!-- ===== ITEMS ===== -->
  <section class="card">
    <h2>Order Items</h2>

    <table class="items-table">
      <thead>
        <tr>
          <th>Item</th>
          <th>HUID</th>
          <th>HSN</th>
          <th class="center">Qty</th>
          <th class="right">Gross (g)</th>
          <th class="right">Net (g)</th>
          <th class="right">Rate (₹)</th>
          <th class="right">Making (₹)</th>
          <th class="right">Line Total (₹)</th>
        </tr>
      </thead>
      <tbody>
        <% subtotal_calc = 0.0 %>
        <% @order.line_items.each do |li| %>
          <% per_gram = (li.jewelry_item.respond_to?(:effective_price_per_gram) ? li.jewelry_item.effective_price_per_gram.to_f : nil) %>
          <% per_line = if per_gram && li.net_weight.to_f > 0 && li.quantity.to_i > 0
                          per_gram * li.net_weight.to_f * li.quantity.to_i
                        else
                          li.rate.to_f
                        end %>
          <% line_total = per_line + li.making_charge.to_f %>
          <% subtotal_calc += line_total %>
          <tr>
            <td class="item-name"><%= li.jewelry_item.name %></td>
            <td><%= li.huid.presence || '-' %></td>
            <td><%= li.hsn.presence || '-' %></td>
            <td class="center"><%= li.quantity %></td>
            <td class="right"><%= '%.2f' % li.gross_weight.to_f %></td>
            <td class="right"><%= '%.2f' % li.net_weight.to_f %></td>
            <td class="right"><%= '%.2f' % per_line %></td>
            <td class="right"><%= '%.2f' % li.making_charge.to_f %></td>
            <td class="right total-cell">
              <%= '%.2f' % line_total %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </section>

  <!-- ===== SUMMARY + PAYMENT ===== -->
  <div class="layout-two">

    <!-- SUMMARY -->
    <aside class="summary-card">
      <h3>Order Summary</h3>

      <div class="summary-row">
        <span>Subtotal</span>
        <span>₹<%= '%.2f' % subtotal_calc %></span>
      </div>

      <div class="summary-row muted">
        <span>Discount</span>
        <span>₹<%= '%.2f' % @order.discount.to_f %></span>
      </div>

      <div class="summary-row muted">
        <span>Making Charges</span>
        <span>₹<%= '%.2f' % @order.charges.to_f %></span>
      </div>

      <hr>

      <div class="summary-row emphasis">
        <span>Taxable Amount</span>
        <span id="taxable-display">
          ₹<%= '%.2f' % (subtotal_calc - @order.discount.to_f + @order.charges.to_f) %>
        </span>
      </div>

      <div class="summary-row">
        <span>CGST</span>
        <span id="cgst-amount">₹0.00</span>
      </div>

      <div class="summary-row">
        <span>IGST</span>
        <span id="igst-amount">₹0.00</span>
      </div>

      <div class="summary-total">
        <span>Total Payable</span>
        <% taxable_calc = subtotal_calc - @order.discount.to_f + @order.charges.to_f %>
        <% cgst_amt = taxable_calc * (@order.cgst_rate.to_f / 100.0) %>
        <% igst_amt = taxable_calc * (@order.igst_rate.to_f / 100.0) %>
        <strong id="total-display">
          ₹<%= '%.2f' % (taxable_calc + cgst_amt + igst_amt) %>
        </strong>
      </div>
    </aside>

    <!-- PAYMENT -->
    <% if @order.status == 'pending' %>
      <section id="charge-form" class="payment-card">
        <h3>Record Payment</h3>
        <p class="hint">
          Finalize the order by confirming tax, discount, and charges.
        </p>

        <form method="post"
              action="<%= record_payment_order_path(@order) %>">
          <input type="hidden"
                 name="authenticity_token"
                 value="<%= form_authenticity_token %>">

          <div class="form-grid">
            <div>
              <label>CGST %</label>
                <input id="cgst_rate_show" name="cgst_rate" type="number" step="0.01"
                       value="<%= @order.cgst_rate.to_f %>">
            </div>

            <div>
              <label>IGST %</label>
                <input id="igst_rate_show" name="igst_rate" type="number" step="0.01"
                       value="<%= @order.igst_rate.to_f %>">
            </div>
          </div>

          <div class="form-actions">
            <button class="btn btn-primary">
              Record Payment & Print Invoice
            </button>
          </div>
        </form>
      </section>
    <% end %>

  </div>
</div>

<!-- JS UNCHANGED -->
<script>
  function money(v){ return '\u20B9' + v.toFixed(2); }
  const subtotal = <%= subtotal_calc %>;
  const discount = <%= @order.discount.to_f %>;
  const charges = <%= @order.charges.to_f %>;

  function update(){
    const taxable = subtotal - discount + charges;
    const cgstRate = parseFloat(document.getElementById('cgst_rate_show').value || 0);
    const igstRate = parseFloat(document.getElementById('igst_rate_show').value || 0);
    const cgst = taxable * (cgstRate/100);
    const igst = taxable * (igstRate/100);
    document.getElementById('cgst-amount').textContent = money(cgst);
    document.getElementById('igst-amount').textContent = money(igst);
    document.getElementById('total-display').textContent = money(taxable + cgst + igst);
  }
  // wire inputs so changes reflect on the summary card
  const cgstInput = document.getElementById('cgst_rate_show');
  const igstInput = document.getElementById('igst_rate_show');
  if(cgstInput) cgstInput.addEventListener('input', update);
  if(igstInput) igstInput.addEventListener('input', update);
  update();
</script>
