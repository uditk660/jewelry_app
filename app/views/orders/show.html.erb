<div class="order-show">

  <!-- ===== HEADER ===== -->
  <header class="order-header">
    <div>
      <h1>Sales Order <span>#<%= @order.id %></span></h1>
      <p>
        Status:
        <strong class="status <%= @order.status %>">
          <%= @order.status.capitalize %>
        </strong>
        · Created <%= @order.created_at.strftime('%d %b %Y, %I:%M %p') %>
      </p>
    </div>

    <div class="header-actions">
      <%= link_to 'Back to Orders', orders_path, class: 'btn btn-secondary' %>
      <% if @order.status == 'pending' %>
        <%= link_to 'Record Payment', '#charge-form', class: 'btn btn-primary' %>
      <% end %>
    </div>
  </header>

  <!-- ===== ITEMS ===== -->
  <section class="card">
    <h2>Order Items</h2>

    <table class="items-table">
      <thead>
        <tr>
          <th>Item</th>
          <th>HUID</th>
          <th>HSN</th>
          <th class="center">Qty</th>
          <th class="right">Gross (g)</th>
          <th class="right">Net (g)</th>
          <th class="right">Rate (₹)</th>
          <th class="right">Making (₹)</th>
          <th class="right">Addl (₹)</th>
          <th class="right">Line Total (₹)</th>
        </tr>
      </thead>
      <tbody>
        <% subtotal_calc = 0.0 %>
        <% @order.line_items.each do |li| %>
          <% per_gram = (li.jewelry_item.respond_to?(:effective_price_per_gram) ? li.jewelry_item.effective_price_per_gram.to_f : nil) %>
          <% per_line = if per_gram && li.net_weight.to_f > 0 && li.quantity.to_i > 0
                          per_gram * li.net_weight.to_f * li.quantity.to_i
                        else
                          li.rate.to_f
                        end %>
          <% add_per_item = li.respond_to?(:additional_charge) ? li.additional_charge.to_f : 0.0 %>
          <% add_total = add_per_item * li.quantity.to_i %>
          <% line_total = per_line + li.making_charge.to_f + add_total %>
          <% subtotal_calc += line_total %>
          <tr>
            <td class="item-name"><%= li.jewelry_item.name %></td>
            <td><%= li.huid.presence || '-' %></td>
            <td><%= li.hsn.presence || '-' %></td>
            <td class="center"><%= li.quantity %></td>
            <td class="right"><%= '%.2f' % li.gross_weight.to_f %></td>
            <td class="right"><%= '%.2f' % li.net_weight.to_f %></td>
            <td class="right"><%= '%.2f' % per_line %></td>
            <td class="right"><%= '%.2f' % li.making_charge.to_f %></td>
            <td class="right"><%= '%.2f' % add_per_item %></td>
            <td class="right total-cell">
              <%= '%.2f' % line_total %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </section>

  <!-- ===== SUMMARY + PAYMENT ===== -->
  <div class="layout-two">

    <!-- SUMMARY -->
    <aside class="summary-card">
      <h3>Order Summary</h3>

      <div class="summary-row">
        <span>Subtotal</span>
        <span>₹<%= '%.2f' % subtotal_calc %></span>
      </div>

      <div class="summary-row muted">
        <span>Discount</span>
        <span id="discount-display">₹<%= '%.2f' % @order.discount.to_f %></span>
      </div>

      <div class="summary-row muted">
        <span>Making Charges</span>
        <span>₹<%= '%.2f' % @order.charges.to_f %></span>
      </div>

      <hr>

      <div class="summary-row emphasis">
        <span>Taxable Amount</span>
        <span id="taxable-display">
          ₹<%= '%.2f' % (subtotal_calc - @order.discount.to_f + @order.charges.to_f) %>
        </span>
      </div>

      <div class="summary-row">
        <span>CGST (1.5%)</span>
        <span id="cgst-amount">₹0.00</span>
      </div>

      <div class="summary-row">
        <span>IGST (1.5%)</span>
        <span id="igst-amount">₹0.00</span>
      </div>

      <div class="summary-total">
        <span>Total Payable</span>
        <% taxable_calc = subtotal_calc - @order.discount.to_f + @order.charges.to_f %>
  <% cgst_amt = taxable_calc * (1.5 / 100.0) %>
  <% igst_amt = taxable_calc * (1.5 / 100.0) %>
        <strong id="total-display">
          ₹<%= '%.2f' % (taxable_calc + cgst_amt + igst_amt) %>
        </strong>
      </div>
    </aside>

    <!-- PAYMENT -->
    <% if @order.status == 'pending' %>
      <section id="charge-form" class="payment-card">
        <h3>Record Payment</h3>
        <p class="hint">
          Finalize the order by confirming tax, discount, and charges.
        </p>

        <form method="post"
              action="<%= record_payment_order_path(@order) %>">
          <input type="hidden"
                 name="authenticity_token"
                 value="<%= form_authenticity_token %>">

          <div class="form-grid">
            <div>
              <label>Discount(If any ?)</label>
              <div style="display:flex;align-items:center;gap:8px">
                <select id="discount-type" style="width:150px">
                  <option value="amount">Amount</option>
                  <option value="percent">Percent</option>
                </select>
                <input id="discount_input" type="number" step="0.01" style="width:200px"
                       value="<%= @order.discount.to_f %>">
              </div>
              <div id="discount-error" style="color:#a00; font-size:12px; display:none; margin-top:4px">Discount cannot exceed subtotal</div>
            </div>

            <div>
              <label>Paid via</label>
              <select name="payment_method" id="payment_method_input" style="width:220px" required>
                <option value="">-- Select --</option>
                <option value="Cash" <%= 'selected' if (@order.respond_to?(:payment_method) && @order.payment_method.to_s == 'Cash') %>>Cash</option>
                <option value="Card" <%= 'selected' if (@order.respond_to?(:payment_method) && @order.payment_method.to_s == 'Card') %>>Card</option>
                <option value="Online" <%= 'selected' if (@order.respond_to?(:payment_method) && @order.payment_method.to_s == 'Online') %>>Online</option>
                <option value="PhonePe" <%= 'selected' if (@order.respond_to?(:payment_method) && @order.payment_method.to_s == 'PhonePe') %>>PhonePe</option>
                <option value="Paytm" <%= 'selected' if (@order.respond_to?(:payment_method) && @order.payment_method.to_s == 'Paytm') %>>Paytm</option>
                <option value="GPay" <%= 'selected' if (@order.respond_to?(:payment_method) && @order.payment_method.to_s == 'GPay') %>>GPay</option>
                <option value="Others" <%= 'selected' if (@order.respond_to?(:payment_method) && @order.payment_method.to_s == 'Others') %>>Others</option>
              </select>
              <div id="payment-error" style="color:#a00; font-size:12px; display:<%= @order.errors[:payment_method].present? ? 'block' : 'none' %>; margin-top:4px">
                <%= (@order.errors[:payment_method].first if @order.errors[:payment_method].present?) || 'Please select a payment method' %>
              </div>
            </div>

            <%# submit fixed tax rates as hidden fields so controller receives them %>
            <input type="hidden" name="cgst_rate" id="cgst_rate_show" value="1.5">
            <input type="hidden" name="igst_rate" id="igst_rate_show" value="1.5">
            <%# hidden numeric discount (amount in rupees) sent to server %>
            <input type="hidden" name="discount" id="discount_hidden" value="<%= @order.discount.to_f %>">
          </div>

          <div class="form-actions">
            <button class="btn btn-primary">
              Record Payment & Print Invoice
            </button>
          </div>
        </form>
      </section>
    <% end %>

  </div>
</div>

<!-- JS UNCHANGED -->
<script>
  function money(v){ return '\u20B9' + v.toFixed(2); }
  const subtotal = <%= subtotal_calc %>;
  const charges = <%= @order.charges.to_f %>;

  function update(){
    const type = document.getElementById('discount-type').value;
    let raw = parseFloat(document.getElementById('discount_input').value || 0) || 0;
    let discountAmt = 0;
    if(type === 'percent'){
      discountAmt = subtotal * raw / 100.0;
    } else {
      discountAmt = raw;
    }
    // clamp discount to subtotal
    const discountErrorEl = document.getElementById('discount-error');
    if(discountAmt > subtotal){
      if(discountErrorEl) discountErrorEl.style.display = 'block';
      discountAmt = subtotal;
    } else {
      if(discountErrorEl) discountErrorEl.style.display = 'none';
    }
    document.getElementById('discount-display').textContent = money(discountAmt);
    const taxable = subtotal - discountAmt + charges;
    const cgstRate = 1.5;
    const igstRate = 1.5;
    const cgst = taxable * (cgstRate/100);
    const igst = taxable * (igstRate/100);
    document.getElementById('cgst-amount').textContent = money(cgst);
    document.getElementById('igst-amount').textContent = money(igst);
    document.getElementById('taxable-display').textContent = money(taxable);
    document.getElementById('total-display').textContent = money(taxable + cgst + igst);
    // update hidden discount in rupees for server submission
    const discountHidden = document.getElementById('discount_hidden');
    if(discountHidden) discountHidden.value = discountAmt.toFixed(2);
  }
  // wire inputs so changes reflect on the summary card
  const cgstInput = document.getElementById('cgst_rate_show');
  const igstInput = document.getElementById('igst_rate_show');
  const discountInput = document.getElementById('discount_input');
  if(cgstInput) cgstInput.addEventListener('input', update);
  if(igstInput) igstInput.addEventListener('input', update);
  if(discountInput) discountInput.addEventListener('input', update);
  const discountTypeEl = document.getElementById('discount-type');
  if(discountTypeEl) discountTypeEl.addEventListener('change', update);
  update();
</script>
