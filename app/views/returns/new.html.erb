<style>
/* Returns new ‚Äî premium form (page-scoped) */
:root{--bg:#f7fafc;--card:#fff;--muted:#6b7280;--text:#0f1724;--border:#e6edf5;--primary:#2563eb;--accent:#eef4ff}
.returns-new{max-width:1000px;margin:24px auto;padding:0 16px;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial}
.returns-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:20px;box-shadow:0 8px 24px rgba(16,24,40,0.04)}
.returns-head{display:flex;align-items:center;justify-content:space-between;gap:12px}
.returns-title{font-size:1.25rem;font-weight:700;color:var(--text)}
.returns-sub{color:var(--muted);font-size:13px}
.form-grid{display:grid;grid-template-columns:1fr 320px;gap:20px;margin-top:14px}
.field{margin-bottom:12px}
.label{display:block;font-weight:600;color:#374151;margin-bottom:6px;font-size:13px}
.input,textarea,select{width:100%;padding:9px 10px;border:1px solid #e9f0f7;border-radius:8px;background:#fbfdff}
.actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
.btn.ghost{background:transparent;border:1px solid var(--border)}
.preview-card{background:#fbfdff;border:1px solid #eef6ff;padding:12px;border-radius:10px}
.item-head{display:flex;gap:12px;align-items:center}
.item-avatar{width:56px;height:56px;border-radius:8px;background:var(--accent);display:flex;align-items:center;justify-content:center;font-size:20px}
.muted{color:var(--muted)}
@media(max-width:820px){.form-grid{grid-template-columns:1fr}}
</style>

<div class="returns-new">
  <div class="returns-card">
    <div class="returns-head">
      <div>
        <div class="returns-title">New Return / Exchange</div>
        <div class="returns-sub">Record returned items, refunds or exchanges and keep inventory synchronized.</div>
      </div>

      <div class="actions">
        <%= link_to 'Back', returns_path, class: 'btn ghost' %>
      </div>
    </div>

    <div class="form-grid">
      <div>
        <%= form_for :return, url: returns_path do |f| %>
          <div class="field">
            <label class="label">Customer</label>
            <%= f.collection_select :customer_id, Customer.order(:first_name), :id, lambda { |c| [c.first_name, c.last_name].join(' ') }, { include_blank: true }, { class: 'input', id: 'return_customer_id' } %>
          </div>

          <div class="field">
            <label class="label">Order / Invoice (optional)</label>
            <%= f.text_field :order_id, class: 'input' %>
          </div>

          <div class="field">
            <label class="label">Returned Item (optional)</label>
            <%= f.collection_select :jewelry_item_id, JewelryItem.order(:name), :id, :name, include_blank: true, class: 'input' %>
          </div>

          <div class="field">
            <label class="label">Quantity</label>
            <%= f.number_field :quantity, min: 1, value: 1, class: 'input', id: 'return_quantity' %>
          </div>

          <div class="field">
            <label class="label">Weight (g)</label>
            <%= f.number_field :weight, step: '0.001', min: 0, class: 'input', id: 'return_weight' %>
          </div>

          <div class="field">
            <label class="label">Returning Rate (‚Çπ / g)</label>
            <%= f.number_field :returning_rate, step: '0.01', min: 0, class: 'input', id: 'return_returning_rate' %>
          </div>

          <div class="field">
            <label class="label">Additional Costs (‚Çπ)</label>
            <%= f.number_field :additional_costs, step: '0.01', min: 0, class: 'input', id: 'return_additional_costs' %>
          </div>

          <div class="field">
            <label class="label">Action</label>
            <%= f.select :action, [['Cash Refund','cash'], ['Exchange','exchange']], {}, {class: 'input'} %>
          </div>

          <div class="field">
            <label class="label">Cash Amount (if refund)</label>
            <%= f.number_field :amount, step: '0.01', min: 0, class: 'input', id: 'return_amount', readonly: true %>
          </div>

          <div class="field">
            <label class="label">Reason</label>
            <%= f.text_area :reason, rows: 3, class: 'input' %>
          </div>

          <div class="field">
            <label class="label">Staff Notes</label>
            <%= f.text_area :notes, rows: 2, class: 'input' %>
          </div>

          <div class="actions">
            <%= f.submit 'Record Return', class: 'btn primary' %>
            <%= link_to 'Cancel', returns_path, class: 'btn ghost' %>
          </div>
        <% end %>
      </div>

      <aside>
        <div class="preview-card">
          <div class="label">Item Preview</div>
          <div style="margin-top:10px">
            <div class="item-head">
              <div class="item-avatar">üíç</div>
              <div>
                <div id="preview_name" style="font-weight:700">Select an item to preview</div>
                <div id="preview_sku" class="muted">SKU will appear here</div>
              </div>
            </div>

            <div style="margin-top:10px" id="preview_meta" class="muted">Item weight, current stock and other metadata will appear here.</div>
            <div id="preview_weight" class="muted" style="margin-top:6px">Weight: - g</div>
            <div id="preview_returning_rate" class="muted" style="margin-top:4px">Returning Rate: -</div>
            <div id="preview_additional_costs" class="muted" style="margin-top:4px">Additional Costs: -</div>
            <div id="preview_amount" class="muted" style="margin-top:6px;font-weight:700">Calculated Cash Amount: -</div>
          </div>

          <div style="margin-top:12px" class="label">Quick Actions</div>
          <div style="margin-top:8px;display:flex;gap:8px">
            <%= link_to 'Open Item', '#', class: 'btn' %>
            <%= link_to 'Search Catalog', jewelry_items_path, class: 'btn ghost' %>
          </div>
        </div>
      </aside>
    </div>
    <script>
      (function(){
        function toFloat(v){ var n = parseFloat(String(v).replace(/,/g, '')); return isNaN(n) ? 0 : n }

        function initReturnForm(){
          var form = document.querySelector('form');
          if(form && form.dataset.returnInit) return; // already initialized
          var customerEl = document.getElementById('return_customer_id');

          var qtyEl = document.getElementById('return_quantity');
          var weightEl = document.getElementById('return_weight');
          var rateEl = document.getElementById('return_returning_rate');
          var addEl = document.getElementById('return_additional_costs');
          var amountEl = document.getElementById('return_amount');

          var previewWeight = document.getElementById('preview_weight');
          var previewRate = document.getElementById('preview_returning_rate');
          var previewAdd = document.getElementById('preview_additional_costs');
          var previewAmount = document.getElementById('preview_amount');

          function updateAmount(){
            var q = toFloat(qtyEl && qtyEl.value || 0);
            var w = toFloat(weightEl && weightEl.value || 0);
            var r = toFloat(rateEl && rateEl.value || 0);
            var a = toFloat(addEl && addEl.value || 0);

            var computed = (q * w * r) + a;
            if(amountEl) amountEl.value = computed.toFixed(2);

            if(previewWeight) previewWeight.textContent = 'Weight: ' + w.toFixed(3) + ' g';
            if(previewRate) previewRate.textContent = 'Returning Rate: ‚Çπ' + r.toFixed(2) + ' /g';
            if(previewAdd) previewAdd.textContent = 'Additional Costs: ‚Çπ' + a.toFixed(2);
            if(previewAmount) previewAmount.textContent = 'Calculated Cash Amount: ‚Çπ' + computed.toFixed(2);
          }

          [qtyEl, weightEl, rateEl, addEl].forEach(function(el){ if(el) el.addEventListener('input', updateAmount) });
          updateAmount();

          function setFormDisabled(disabled){
            if(!form) return;
            var elems = form.querySelectorAll('input, textarea, select, button');
            elems.forEach(function(el){
              if(el === customerEl) return;
              try{ el.disabled = disabled; }catch(e){}
            });
          }

          // initialize disabled state based on whether a customer is selected
          var hasCustomer = customerEl && String(customerEl.value).trim() !== '';
          setFormDisabled(!hasCustomer);

          if(customerEl) customerEl.addEventListener('change', function(){ setFormDisabled(!(String(customerEl.value).trim() !== '')) });

          if(form) form.dataset.returnInit = '1';
        }

        ['DOMContentLoaded','turbolinks:load','turbo:load'].forEach(function(ev){ document.addEventListener(ev, initReturnForm) });
      })();
    </script>
  </div>
</div>
