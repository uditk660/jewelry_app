<style>
/* Home dashboard page-scoped styles */
.hd { max-width:1400px; margin:36px auto; padding:0 28px; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial; color:#0b1220 }
.hd-header { display:flex; justify-content:space-between; align-items:center }
.hd-title { font-size:28px; margin:0; font-weight:700 }
.hd-sub { color:#475569 }
.hd-grid { display:grid; grid-template-columns:repeat(12,1fr); gap:24px; margin-top:20px }
.card { background:#fff; border-radius:12px; padding:18px; box-shadow:0 10px 30px rgba(2,6,23,0.06); border:1px solid rgba(2,6,23,0.03) }
.card { transform:translateY(0); opacity:1 }
.card.animated { animation:fadeInUp .6s cubic-bezier(.2,.9,.2,1) both }
.card:hover { transform:translateY(-6px); box-shadow:0 18px 40px rgba(2,6,23,0.08) }

@keyframes fadeInUp { from { opacity:0; transform:translateY(8px) } to { opacity:1; transform:translateY(0) } }
.metrics { display:grid; grid-template-columns:repeat(4,1fr); gap:16px }
.metric { padding:14px; border-radius:10px; background:linear-gradient(180deg,#ffffff,#fbfdff); border:1px solid #eef2ff }
.metric .label { font-size:12px; color:#64748b }
.metric .value { font-size:20px; font-weight:700; margin-top:6px }
.metric .value .count { display:inline-block; min-width:60px }
.section-title { font-size:16px; margin:0 0 8px 0 }
.list { list-style:none; padding:0; margin:0 }
.list li { padding:10px 0; border-bottom:1px dashed #f1f5f9 }
.muted { color:#94a3b8 }
@media(max-width:1000px){ .metrics { grid-template-columns:repeat(2,1fr) } .hd-grid { grid-template-columns:repeat(1,1fr) } }
</style>

<div class="hd">
  <div class="hd-header">
    <div>
      <h1 class="hd-title">Dashboard</h1>
      <div class="hd-sub">Summary of sales, inventory alerts and recent activity</div>
    </div>
    <div style="text-align:right">
      <div class="muted">As of</div>
      <div style="font-weight:600"><%= Time.now.in_time_zone('Asia/Kolkata').strftime('%Y-%m-%d %H:%M') %> IST</div>
    </div>
  </div>

  <div class="hd-grid">
    <div class="card" style="grid-column: span 8">
      <div class="metrics">
        <div class="metric" style="background:linear-gradient(90deg,#fff7ed,#fff1e6);border-color:#ffedd5">
          <div class="label">Today</div>
          <div class="value">₹<span class="count" data-target="<%= (@today_total || 0).to_f %>">0.00</span></div>
          <div class="muted">Live</div>
        </div>
        <div class="metric" style="background:linear-gradient(90deg,#eef2ff,#eef6ff);border-color:#e0e7ff">
          <div class="label">This Week</div>
          <div class="value">₹<span class="count" data-target="<%= (@week_total || 0).to_f %>">0.00</span></div>
          <div class="muted">Mon - Sun</div>
        </div>
        <div class="metric" style="background:linear-gradient(90deg,#ecfdf5,#f0fdf4);border-color:#bbf7d0">
          <div class="label">This Month</div>
          <div class="value">₹<span class="count" data-target="<%= (@month_total || 0).to_f %>">0.00</span></div>
          <div class="muted">Monthly</div>
        </div>
        <div class="metric" style="background:linear-gradient(90deg,#fff1f2,#fff4f6);border-color:#fecaca">
          <div class="label">Low Stock</div>
          <div class="value"><span class="count" data-target="<%= @low_stock_items.count %>">0</span></div>
          <div class="muted">Items &le; 5</div>
        </div>
      </div>

      <div style="display:flex;gap:20px;margin-top:18px;align-items:flex-start">
        <div style="flex:1">
          <h3 class="section-title">Recent Orders</h3>
          <ul class="list">
            <% @recent_orders.each do |o| %>
              <li>
                <div style="display:flex;justify-content:space-between">
                  <div>
                    <strong><%= o.invoice_number %></strong>
                    <div class="muted"><%= o.customer.try(:name) || 'Guest' %> • <%= o.sale_date %></div>
                  </div>
                  <div style="text-align:right">₹<%= '%.2f' % (o.total || 0) %></div>
                </div>
              </li>
            <% end %>
          </ul>
        </div>

        <div style="width:380px">
          <h3 class="section-title">Top Items — This Week</h3>
          <ul class="list">
            <% @top_items_week.each do |ti| %>
              <li style="display:flex;justify-content:space-between;align-items:center">
                <div><%= ti.name %></div>
                <div class="muted">Qty: <strong><%= ti.qty_sold %></strong></div>
              </li>
            <% end %>
          </ul>

          <div style="margin-top:14px">
            <h4 class="section-title">Sales (last 7 days)</h4>
            <% if @sales_values && @sales_values.any? %>
              <% max_h = 60.0 %>
              <svg id="sales-spark" width="100%" height="80" viewBox="0 0 100 80" preserveAspectRatio="none" style="display:block;margin-top:8px">
                <% vals = @sales_values.map { |v| (v.to_f / (@sales_max.nonzero? ? @sales_max : 1.0)) * max_h } %>
                <% step = 100.0 / ([vals.size,1].max) %>
                <% pts = vals.each_with_index.map { |h,i| "#{(i * step).round(2)},#{(max_h - h).round(2)}" } %>
                <polyline id="sales-poly" points="<%= pts.join(' ') %>" fill="none" stroke="#0ea5a4" stroke-width="1.5" stroke-linejoin="round" stroke-linecap="round" stroke-linejoin="round" />
              </svg>
              <div style="display:flex;justify-content:space-between;margin-top:6px;font-size:12px;color:#64748b">
                <% @sales_labels.each do |lbl| %>
                  <div><%= lbl %></div>
                <% end %>
              </div>
            <% else %>
              <div class="muted">No recent sales data</div>
            <% end %>
          </div>
        </div>
      </div>
    </div>

    <div class="card" style="grid-column: span 4">
      <h3 class="section-title">Today's Metal Rates</h3>
      <% if @today_rates.any? %>
        <ul class="list">
          <% @today_rates.each do |r| %>
            <li>
              <div style="display:flex;justify-content:space-between;align-items:center">
                <div>
                  <strong><%= r.metal_type %></strong>
                  <div class="muted" style="font-size:12px">Date: <%= r.date %></div>
                </div>
                <div style="text-align:right">
                  <div style="font-weight:700;font-size:16px">₹<%= '%.2f' % (r.price_cents_per_gram.to_f / 100.0) %></div>
                </div>
              </div>
            </li>
          <% end %>
        </ul>
      <% else %>
        <div class="muted">No rates set for today</div>
      <% end %>

      <div style="margin-top:14px;"> <a href="<%= new_rate_path %>" class="btn">Set Today's Rates</a> </div>

    </div>

    <div class="card" style="grid-column: span 4">
      <h3 class="section-title">Inventory Alerts</h3>
      <% if @low_stock_items.any? %>
        <ul class="list">
          <% @low_stock_items.each do |it| %>
            <li>
              <div style="display:flex;justify-content:space-between">
                <div><strong><%= it.name %></strong><div class="muted">SKU: <%= it.sku %></div></div>
                <div style="text-align:right">Qty: <strong><%= it.quantity %></strong></div>
              </div>
            </li>
          <% end %>
        </ul>
      <% else %>
        <div class="muted">No low stock items</div>
      <% end %>

      <div style="margin-top:18px">
        <a href="<%= inventory_items_path %>" class="btn">Open Inventory</a>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  function initDashboard(){
    // stagger card animations
    document.querySelectorAll('.card').forEach(function(el, idx){
      el.classList.remove('animated');
      setTimeout(function(){ el.classList.add('animated'); }, idx * 80);
    });

    // number counters
    function animateCount(el, target, duration){
      target = parseFloat(target) || 0;
      var start = 0;
      var startTime = null;
      function step(ts){
        if(!startTime) startTime = ts;
        var progress = Math.min((ts - startTime) / duration, 1);
        var current = start + (target - start) * progress;
        if(el.dataset.decimals && el.dataset.decimals != '0'){
          el.textContent = current.toFixed(parseInt(el.dataset.decimals));
        } else {
          el.textContent = Math.round(current);
        }
        if(progress < 1) requestAnimationFrame(step);
      }
      requestAnimationFrame(step);
    }

    document.querySelectorAll('.count').forEach(function(span){
      var tgt = span.getAttribute('data-target');
      if(!tgt) return;
      // reset display to 0 so animation always runs
      if(tgt.indexOf('.') !== -1){ span.dataset.decimals = '2'; span.textContent = '0.00'; }
      else { span.textContent = '0'; }
      animateCount(span, tgt, 900);
    });

    // animate SVG polyline draw
    var poly = document.getElementById('sales-poly');
    if(poly){
      var len = poly.getTotalLength();
      poly.style.transition = poly.style.WebkitTransition = 'none';
      poly.style.strokeDasharray = len + ' ' + len;
      poly.style.strokeDashoffset = len;
      setTimeout(function(){ poly.style.transition = 'stroke-dashoffset 900ms ease-out'; poly.style.strokeDashoffset = '0'; }, 300);
    }
  }

  // Support Turbolinks and Turbo as well as normal loads
  if(window.Turbolinks){
    document.addEventListener('turbolinks:load', initDashboard);
    document.addEventListener('turbolinks:before-cache', function(){ document.querySelectorAll('.card.animated').forEach(function(el){ el.classList.remove('animated'); }); });
  }
  if(window.Turbo){
    document.addEventListener('turbo:load', initDashboard);
    document.addEventListener('turbo:before-cache', function(){ document.querySelectorAll('.card.animated').forEach(function(el){ el.classList.remove('animated'); }); });
  }

  document.addEventListener('DOMContentLoaded', initDashboard);
  if(document.readyState === 'complete' || document.readyState === 'interactive'){
    setTimeout(initDashboard, 50);
  }
})();
</script>
