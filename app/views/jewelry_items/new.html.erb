<div class="container">
  <div class="page-header">
    <div>
      <h1>New Jewelry Item</h1>
      <p class="lead">Create a new catalog item ‚Äî set pricing, stock and attributes.</p>
    </div>
    <div class="right">
      <%= link_to 'Back to Catalog', jewelry_items_path, class: 'btn' %>
    </div>
  </div>

  <div class="card">
    <div class="edit-grid">
      <div class="edit-form">
        <%= form_for @item, url: jewelry_items_path do |f| %>
          <div class="form-row" style="margin-bottom:10px">
            <div style="flex:1">
              <%= f.label :metal_id, 'Metal' %>
              <%= f.collection_select :metal_id, (@metals || []), :id, :name, include_blank: '‚Äî Select metal ‚Äî', class: 'form-control' %>
            </div>
            <div style="width:220px; margin-left:12px">
              <%= f.label :purity_id, 'Purity' %>
              <%= f.collection_select :purity_id, (@purities || []), :id, :name, include_blank: '‚Äî Select purity ‚Äî', class: 'form-control' %>
            </div>
          </div>

          <div class="form-row" style="margin-bottom:8px;align-items:center">
            <div style="flex:1">
              <strong>Items to create</strong>
              <div style="color:#64748b;font-size:13px">Add multiple items sharing the selected Metal & Purity.</div>
            </div>
            <div style="margin-left:12px">
              <button type="button" id="add-row" class="btn">Add row</button>
            </div>
          </div>

          <div style="overflow:auto">
            <table id="items-table" style="width:100%;border-collapse:collapse">
              <thead>
                <tr>
                  <th style="text-align:left;padding:6px">Name</th>
                  <th style="text-align:left;padding:6px;width:120px">HUID</th>
                  <th style="text-align:left;padding:6px;width:120px">Qty</th>
                  <th style="text-align:left;padding:6px;width:140px">Weight (g)</th>
                  <th style="text-align:left;padding:6px">Description</th>
                  <th style="padding:6px;width:48px"></th>
                </tr>
              </thead>
              <tbody>
                <tr class="contents">
                  <td style="padding:6px"><input name="items[][name]" type="text" class="form-control" /></td>
                  <td style="padding:6px"><input name="items[][sku]" type="text" class="form-control sku-field" /></td>
                  <td style="padding:6px"><input name="items[][quantity]" type="number" min="0" step="1" value="1" class="form-control" /></td>
                  <td style="padding:6px"><input name="items[][weight_grams]" type="number" step="0.001" class="form-control" /></td>
                  <td style="padding:6px"><input name="items[][description]" type="text" class="form-control" /></td>
                  <td style="padding:6px"><button type="button" class="remove-row btn">X</button></td>
                </tr>
              </tbody>
            </table>
          </div>

          <div style="margin-top:14px">
            <%= f.submit 'Create Items', class: 'btn btn-primary' %>
          </div>
        <% end %>
      </div>

      <div class="edit-preview">
        <div class="product-hero card">
          <div class="product-grid">
            <div class="product-media">
              <div class="product-image">üíç</div>
            </div>
            <div class="product-details">
              <h2 id="preview-title" class="product-title"><%= @item.name.presence || 'New item' %></h2>
              <div id="preview-meta" class="product-meta small muted">SKU: <span id="preview-sku"><%= @item.sku.presence || '‚Äî' %></span></div>
              <div class="product-pricing" style="margin-top:12px">
                <div id="preview-price" class="price-large"><%= @item.price.present? ? "\u20B9#{'%.2f' % @item.price}" : '‚Äî' %></div>
                <div class="product-attributes small muted" style="margin-left:12px">
                  <div>Weight: <strong id="preview-weight"><%= @item.weight_grams.to_f %> g</strong></div>
                </div>
              </div>
              <div id="preview-desc" class="product-desc" style="margin-top:10px"><%= simple_format(@item.description.to_s.presence || '') %></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>






<script>
  // helper: run a callback on DOM ready and on Turbolinks/Turbo navigation
  window.addReadyListener = function(fn){
    if(document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', fn);
    } else { fn(); }
    if(typeof Turbolinks !== 'undefined') document.addEventListener('turbolinks:load', fn);
    if(typeof Turbo !== 'undefined') document.addEventListener('turbo:load', fn);
  };

  // live preview sync for new/edit forms
  (function(){
      // Purity should only be selectable after a Metal is chosen.
      addReadyListener(function(){
        const form = document.querySelector('form');
        if(!form) return;
        const metalEl = document.querySelector('select[name="jewelry_item[metal_id]"]');
        const purityEl = document.querySelector('select[name="jewelry_item[purity_id]"]');
        const skuEl = document.querySelector('input[name="jewelry_item[sku]"]');
        if(!metalEl || !purityEl) return;

        // helper: generate SKU of 5 uppercase alphanumeric characters
        function rndAlnum(n){
          const _ALNUM = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
          let out=''; for(let i=0;i<n;i++) out += _ALNUM.charAt(Math.floor(Math.random()*_ALNUM.length)); return out;
        }
        function generateSkuIfEmpty(){
          if(!skuEl) return;
          if(skuEl.value && skuEl.value.trim().length) return;
          skuEl.value = rndAlnum(5);
          const previewSku = document.getElementById('preview-sku'); if(previewSku) previewSku.textContent = skuEl.value;
        }

        // Disable all inputs (except metal & purity) until both metal and purity are selected
        function setFieldsDisabled(disabled){
          const selector = 'input.form-control, textarea.form-control, select.form-control';
          const els = form.querySelectorAll(selector);
            els.forEach(function(el){
            if(el === metalEl) { el.disabled = false; return; }
            if(el === purityEl) { el.disabled = !metalEl.value; return; }
            el.disabled = disabled;
          });
          // determine whether table rows are valid
          const submit = form.querySelector('input[type="submit"], button[type="submit"]');
          try {
            const rows = document.querySelectorAll('#items-table tbody tr.contents');
            const rowsValid = Array.prototype.slice.call(rows).every(function(row){
              const name = (row.querySelector('input[name$="[name]"]')||{}).value || '';
              const sku = (row.querySelector('input[name$="[sku]"]')||{}).value || '';
              const qty = (row.querySelector('input[name$="[quantity]"]')||{}).value || '';
              return name.trim().length > 0 && sku.trim().length > 0 && (parseInt(qty) > 0);
            });
            if(submit) submit.disabled = disabled || !metalEl.value || !purityEl.value || !rowsValid;
          } catch(e){ if(submit) submit.disabled = disabled || !metalEl.value || !purityEl.value; }
        }

        // Expose a global helper so other scripts can re-evaluate submit enablement
        window.updateJewelryItemSubmitState = function(){
          const formEl = document.querySelector('form');
          if(!formEl) return;
          const submitBtn = formEl.querySelector('input[type="submit"], button[type="submit"]');
          const metalSel = document.querySelector('select[name="jewelry_item[metal_id]"]');
          const puritySel = document.querySelector('select[name="jewelry_item[purity_id]"]');
          let rowsValid = false;
          try{
            const rows = document.querySelectorAll('#items-table tbody tr.contents');
            rowsValid = rows && rows.length>0 && Array.prototype.slice.call(rows).every(function(row){
              const name = (row.querySelector('input[name$="[name]"]')||{}).value || '';
              const sku = (row.querySelector('input[name$="[sku]"]')||{}).value || '';
              const qty = (row.querySelector('input[name$="[quantity]"]')||{}).value || '';
              return name.trim().length > 0 && sku.trim().length > 0 && (parseInt(qty) > 0);
            });
          }catch(e){ rowsValid = false; }
          if(submitBtn) submitBtn.disabled = !(metalSel && puritySel && metalSel.value && puritySel.value && rowsValid);
        };

        // initialize: purity disabled until metal selected; other fields disabled until both selected
        purityEl.disabled = !metalEl.value;
        setFieldsDisabled(true);
        if(window.updateJewelryItemSubmitState) window.updateJewelryItemSubmitState();

        metalEl.addEventListener('change', function(){
          purityEl.disabled = !metalEl.value;
          setFieldsDisabled(!(metalEl.value && purityEl.value));
          if(window.updateJewelryItemSubmitState) window.updateJewelryItemSubmitState();
        });

        purityEl.addEventListener('change', function(){
          setFieldsDisabled(!(metalEl.value && purityEl.value));
          if(metalEl.value && purityEl.value){ generateSkuIfEmpty(); }
          if(window.updateJewelryItemSubmitState) window.updateJewelryItemSubmitState();
        });

        // guard submission: require both selections
        form.addEventListener('submit', function(e){
          if(!metalEl.value || !purityEl.value){
            e.preventDefault();
            alert('Please select both Metal and Purity before creating an item.');
          }
        });
      });
    function slugify(s){
      return s.toString().toUpperCase().replace(/[^A-Z0-9]+/g, '').slice(0,10);
    }

    const _ALNUM = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    function rndAlnum(n){
      let out='';
      for(let i=0;i<n;i++) out += _ALNUM.charAt(Math.floor(Math.random()*_ALNUM.length));
      return out;
    }

    const nameEl = document.querySelector('input[name="jewelry_item[name]"]');
    const descEl = document.querySelector('textarea[name="jewelry_item[description]"]');
  const priceRupeesEl = document.getElementById('price_rupees');
  const priceHiddenEl = document.getElementById('price_cents_hidden');
    const weightEl = document.querySelector('input[name="jewelry_item[weight_grams]"]');
    const skuEl = document.querySelector('input[name="jewelry_item[sku]"]');

    const previewTitle = document.getElementById('preview-title');
    const previewSku = document.getElementById('preview-sku');
    const previewPrice = document.getElementById('preview-price');
    const previewWeight = document.getElementById('preview-weight');
    const previewDesc = document.getElementById('preview-desc');

    function updatePreview(){
      if(nameEl) previewTitle.textContent = nameEl.value || 'New item';
      if(descEl) previewDesc.innerHTML = (descEl.value || '').replace(/\n/g,'<br>');
      // show rupees formatted (price_cents hidden field stores integer paise)
      let rupeesText = '‚Äî';
      if(priceHiddenEl && priceHiddenEl.value){
        rupeesText = '\u20B9' + (parseInt(priceHiddenEl.value)/100).toFixed(2);
      } else if(priceRupeesEl && priceRupeesEl.value){
        // user-entered rupees shown immediately
        const v = parseFloat(priceRupeesEl.value);
        if(!isNaN(v)) rupeesText = '\u20B9' + v.toFixed(2);
      }
      previewPrice.textContent = rupeesText;
      if(weightEl) previewWeight.textContent = (parseFloat(weightEl.value || 0)).toFixed(2) + ' g';
      if(skuEl && skuEl.value.trim().length) previewSku.textContent = skuEl.value;
    }

    // generate SKU when name changes, only if sku field is empty (user hasn't manually set it)
    function maybeGenerateSku(){
      if(!skuEl) return;
      // For new form, always prefill SKU if empty. Field is readonly so user can't change it here.
      if(skuEl.value && skuEl.value.trim().length) { previewSku.textContent = skuEl.value; return; }
      // Produce a concise 5-character uppercase alphanumeric SKU
      skuEl.value = rndAlnum(5);
      previewSku.textContent = skuEl.value || '‚Äî';
    }

    [nameEl, descEl, priceRupeesEl, weightEl, skuEl].forEach(el=>{ if(!el) return; el.addEventListener('input', function(){ updatePreview(); }); });
    if(nameEl) nameEl.addEventListener('input', function(){ maybeGenerateSku(); });

    // sync rupees -> paise hidden field
    if(priceRupeesEl){
      // price_rupees is readonly ‚Äî keep hidden paise in sync when JS updates value
      const syncPriceHidden = function(){
        const v = parseFloat(priceRupeesEl.value);
        if(isNaN(v)) { priceHiddenEl.value = ''; } else { priceHiddenEl.value = Math.round(v * 100); }
      };
      // expose a price update function below that will call syncPriceHidden and updatePreview
    }

    // initial fill
  // initial sync: ensure hidden paise is set if rupees present
    if(priceRupeesEl && priceRupeesEl.value && priceHiddenEl) priceHiddenEl.value = Math.round(parseFloat(priceRupeesEl.value) * 100);
  maybeGenerateSku();
  updatePreview();
  })();
</script>

<script>
  // Multi-row helper: add/remove rows and auto-generate SKUs for new rows
  addReadyListener(function(){
    const tbl = document.getElementById('items-table');
    if(!tbl) return;
    const tbody = tbl.querySelector('tbody');
    const addBtn = document.getElementById('add-row');
    function rndAlnum(n){ const _ALNUM = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'; let out=''; for(let i=0;i<n;i++) out += _ALNUM.charAt(Math.floor(Math.random()*_ALNUM.length)); return out; }

    function bindRow(row){
      const remove = row.querySelector('.remove-row');
      const nameInput = row.querySelector('input[name$="[name]"]');
      const skuInput = row.querySelector('.sku-field');
      const qtyInput = row.querySelector('input[name$="[quantity]"]');
      if(!skuInput) return;
      // generate SKU when name is filled and SKU empty
      nameInput && nameInput.addEventListener('input', function(){ if(!skuInput.value || skuInput.value.trim()==='') skuInput.value = rndAlnum(5); window.updateJewelryItemSubmitState(); });
      [skuInput, qtyInput].forEach(function(inp){ if(inp) inp.addEventListener('input', window.updateJewelryItemSubmitState); });
      remove && remove.addEventListener('click', function(){
        if(tbody.querySelectorAll('tr.contents').length <= 1){
          // clear fields instead of removing last row
          row.querySelectorAll('input').forEach(i=>i.value = '');
        } else { row.remove(); }
        window.updateJewelryItemSubmitState();
      });
    }

    // bind existing row
    tbody.querySelectorAll('tr.contents').forEach(bindRow);

    // validate a row has required fields filled
    function isRowValid(row){
      const name = (row.querySelector('input[name$="[name]"]')||{}).value || '';
      const sku = (row.querySelector('input[name$="[sku]"]')||{}).value || '';
      const qty = (row.querySelector('input[name$="[quantity]"]')||{}).value || '';
      return name.trim().length > 0 && sku.trim().length > 0 && (parseInt(qty) > 0);
    }

    function allRowsValid(){
      const rows = tbody.querySelectorAll('tr.contents');
      if(!rows || rows.length === 0) return false;
      return Array.prototype.slice.call(rows).every(isRowValid);
    }

    function updateSubmitState(){
      const form = document.querySelector('form');
      const submit = form ? form.querySelector('input[type="submit"], button[type="submit"]') : null;
      const metalSel = document.querySelector('select[name="jewelry_item[metal_id]"]');
      const puritySel = document.querySelector('select[name="jewelry_item[purity_id]"]');
      const enabled = allRowsValid() && metalSel && puritySel && metalSel.value && puritySel.value;
      if(submit) submit.disabled = !enabled;
    }

    addBtn && addBtn.addEventListener('click', function(e){
      // debounce accidental double-clicks
      const last = parseInt(addBtn.dataset.lastAdd || '0', 10);
      if(Date.now() - last < 300) return;
      addBtn.dataset.lastAdd = String(Date.now());

      const rows = tbody.querySelectorAll('tr.contents');
      const lastRow = rows[rows.length-1];
      // require last row to be filled before adding a new one
      if(lastRow && !isRowValid(lastRow)){
        const firstMissing = lastRow.querySelector('input[name$="[name]"]');
        if(firstMissing) firstMissing.focus();
        return;
      }

      const first = tbody.querySelector('tr.contents');
      if(!first) return;
      const clone = first.cloneNode(true);
      // clear values
      clone.querySelectorAll('input').forEach(function(i){ i.value = (i.type === 'number') ? '' : ''; });
      tbody.appendChild(clone);
      bindRow(clone);
      // focus the name field of the newly added row
      const newRows = tbody.querySelectorAll('tr.contents');
      const newRow = newRows[newRows.length-1];
      const nameField = newRow.querySelector('input[name$="[name]"]');
      if(nameField) nameField.focus();
      window.updateJewelryItemSubmitState();
    });

    // Preview & price scripts expect single-field names; provide fallbacks pointing to first row
    (function(){
      const first = tbody.querySelector('tr.contents');
      if(!first) return;
      // If single-field name selectors are missing, create pointer elements for preview scripts
      if(!document.querySelector('input[name="jewelry_item[name]"]')){
        const pseudoName = first.querySelector('input[name$="[name]"]');
        const pseudoDesc = first.querySelector('input[name$="[description]"]') || first.querySelector('textarea[name$="[description]"]');
        const pseudoWeight = first.querySelector('input[name$="[weight_grams]"]');
        const pseudoQty = first.querySelector('input[name$="[quantity]"]');
        const pseudoSku = first.querySelector('input[name$="[sku]"]');
        // attach input events that update preview elements used earlier
        function attachPreviewListener(src){ if(!src) return; src.addEventListener('input', function(){ const ev = new Event('input'); document.dispatchEvent(ev); }); }
        attachPreviewListener(pseudoName); attachPreviewListener(pseudoDesc); attachPreviewListener(pseudoWeight); attachPreviewListener(pseudoQty); attachPreviewListener(pseudoSku);
      }
    })();
  });
</script>

  <script>
    // Compute price from purity price per gram √ó weight √ó quantity
      (function(){
        // Build purity map from server-side data including effective per-gram price (purity.updated_price or latest metal_stock)
        const PURITIES = <%= (@purities || []).map do |p|
          per_gram = if p.updated_price.present?
            p.updated_price.to_f
          else
            ms = p.metal&.metal_stocks&.order(created_at: :desc)&.first
            (ms && ms.price_cents_per_gram.present?) ? (ms.price_cents_per_gram.to_f / 100.0) : 0.0
          end
          { id: p.id, per_gram_price: per_gram, name: p.name, metal_id: p.metal_id }
        end.to_json.html_safe %>;
        function findPurity(id){ return PURITIES.find(x=>String(x.id) === String(id)); }

        addReadyListener(function(){
          const metalEl = document.querySelector('select[name="jewelry_item[metal_id]"]');
          const purityEl = document.querySelector('select[name="jewelry_item[purity_id]"]');
          const weightEl = document.querySelector('input[name="jewelry_item[weight_grams]"]');
          const qtyEl = document.querySelector('input[name="jewelry_item[quantity]"]');
          const priceRupeesEl = document.getElementById('price_rupees');
          const priceHiddenEl = document.getElementById('price_cents_hidden');

          function computeAndSetPrice(){
            if(!priceRupeesEl || !priceHiddenEl) return;
            const purity = purityEl ? findPurity(purityEl.value) : null;
            const perGram = purity && (purity.per_gram_price || purity.per_gram_price === 0) ? parseFloat(purity.per_gram_price) : 0;
            const weight = parseFloat((weightEl && weightEl.value) || 0);
            const qty = parseFloat((qtyEl && qtyEl.value) || 1);
            const total = perGram * (isNaN(weight) ? 0 : weight) * (isNaN(qty) ? 1 : qty);
            priceRupeesEl.value = isNaN(total) ? '' : total.toFixed(2);
            if(priceRupeesEl.value) priceHiddenEl.value = Math.round(parseFloat(priceRupeesEl.value) * 100);
            const previewPrice = document.getElementById('preview-price');
            if(previewPrice) previewPrice.textContent = priceRupeesEl.value ? '\u20B9' + parseFloat(priceRupeesEl.value).toFixed(2) : '‚Äî';
          }

          // Helper: populate purity <select> with purities that match the selected metal
          function populatePurityOptions(selectedMetalId){
            if(!purityEl) return;
            const prev = purityEl.value;
            // build options: blank first
            purityEl.innerHTML = '';
            const blank = document.createElement('option');
            blank.value = '';
            blank.text = '‚Äî Select purity ‚Äî';
            purityEl.appendChild(blank);
            // choose purities matching metalId; if none selected, show all
            const list = PURITIES.filter(function(p){
              return !selectedMetalId || String(p.metal_id) === String(selectedMetalId);
            });
            list.forEach(function(p){
              const opt = document.createElement('option');
              opt.value = p.id;
              opt.text = p.name;
              purityEl.appendChild(opt);
            });
            // restore previous selection if still present
            if(prev){
              const still = Array.prototype.slice.call(purityEl.options).some(o=>String(o.value)===String(prev));
              if(still) purityEl.value = prev; else purityEl.value = '';
            }
          }

          // Attach listeners: purity, weight and quantity
          [purityEl, weightEl, qtyEl].forEach(el=>{ if(!el) return; el.addEventListener('input', computeAndSetPrice); el.addEventListener('change', computeAndSetPrice); });
          if(metalEl){
            // filter purities when metal changes and recompute price
            metalEl.addEventListener('change', function(){
              populatePurityOptions(metalEl.value);
              // allow any other listeners (from other script) to run first
              setTimeout(computeAndSetPrice, 50);
            });
          }

          // Initial populate (respect current metal selection)
          populatePurityOptions(metalEl ? metalEl.value : null);

          // Ensure initial compute runs
          computeAndSetPrice();
        });
      })();
  </script>
