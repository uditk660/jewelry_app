<div class="container">
  <div class="page-header">
    <div>
      <h1>New Jewelry Item</h1>
      <p class="lead">Create a new catalog item ‚Äî set pricing, stock and attributes.</p>
    </div>
    <div class="right">
      <%= link_to 'Back to Catalog', jewelry_items_path, class: 'btn' %>
    </div>
  </div>

  <div class="card">
    <div class="edit-grid">
      <div class="edit-form">
        <%= form_for @item, url: jewelry_items_path do |f| %>
          <div class="form-row" style="margin-bottom:10px">
            <div style="flex:1">
              <%= f.label :metal_id, 'Metal' %>
              <%= f.collection_select :metal_id, (@metals || []), :id, :name, include_blank: '‚Äî Select metal ‚Äî', class: 'form-control' %>
            </div>
            <div style="width:220px; margin-left:12px">
              <%= f.label :purity_id, 'Purity' %>
              <%= f.collection_select :purity_id, (@purities || []), :id, :name, include_blank: '‚Äî Select purity ‚Äî', class: 'form-control' %>
            </div>
          </div>

          <div class="form-row">
            <div style="flex:1">
              <%= f.label :name %>
              <%= f.text_field :name, class: 'form-control' %>
            </div>
          </div>

          <div style="margin-top:10px">
            <%= f.label :description %>
            <%= f.text_area :description, rows: 4, class: 'form-control' %>
          </div>

          <div class="form-row" style="margin-top:10px">
            <div style="flex:1">
              <%= f.label :price_cents, 'Price (‚Çπ) ‚Äî computed from purity √ó weight √ó qty' %>
              <%= text_field_tag 'price_rupees', (@item.price.present? ? ('%.2f' % @item.price) : ''), class: 'form-control', id: 'price_rupees', placeholder: 'e.g. 1234.50', readonly: true %>
              <%= f.hidden_field :price_cents, id: 'price_cents_hidden' %>
            </div>
            <div style="width:220px;margin-left:12px">
              <%= f.label :weight_grams, 'Weight (g)' %>
              <%= f.number_field :weight_grams, step: 0.01, class: 'form-control' %>
            </div>
          </div>

          <div class="form-row" style="margin-top:10px">
            <div style="flex:1">
              <%= f.label :sku %>
              <%= f.text_field :sku, class: 'form-control', readonly: true %>
            </div>
            <div style="width:220px;margin-left:12px">
              <%= f.label :quantity, 'Quantity (pieces)' %>
              <%= f.number_field :quantity, step: 1, min: 0, class: 'form-control' %>
            </div>
          </div>

          <div style="margin-top:14px">
            <%= f.submit 'Create Item', class: 'btn btn-primary' %>
            <%= link_to 'Cancel', jewelry_items_path, class: 'btn btn-outline' %>
          </div>
        <% end %>
      </div>

      <div class="edit-preview">
        <div class="product-hero card">
          <div class="product-grid">
            <div class="product-media">
              <div class="product-image">üíç</div>
            </div>
            <div class="product-details">
              <h2 id="preview-title" class="product-title"><%= @item.name.presence || 'New item' %></h2>
              <div id="preview-meta" class="product-meta small muted">SKU: <span id="preview-sku"><%= @item.sku.presence || '‚Äî' %></span></div>
              <div class="product-pricing" style="margin-top:12px">
                <div id="preview-price" class="price-large"><%= @item.price.present? ? "\u20B9#{'%.2f' % @item.price}" : '‚Äî' %></div>
                <div class="product-attributes small muted" style="margin-left:12px">
                  <div>Weight: <strong id="preview-weight"><%= @item.weight_grams.to_f %> g</strong></div>
                </div>
              </div>
              <div id="preview-desc" class="product-desc" style="margin-top:10px"><%= simple_format(@item.description.to_s.presence || '') %></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // live preview sync for new/edit forms
  (function(){
    // Disable form fields until metal + purity are selected
    function setFormEnabled(enabled){
      const selectors = ['input.form-control:not([readonly])','textarea.form-control','input[type=number]'];
      const els = document.querySelectorAll(selectors.join(','));
      els.forEach(el=>{ el.disabled = !enabled; });
      // keep metal and purity enabled
      const metalEl = document.querySelector('select[name="jewelry_item[metal_id]"]');
      const purityEl = document.querySelector('select[name="jewelry_item[purity_id]"]');
      if(metalEl) metalEl.disabled = false;
      if(purityEl) purityEl.disabled = false;
    }

    function bothSelected(){
      const m = document.querySelector('select[name="jewelry_item[metal_id]"]');
      const p = document.querySelector('select[name="jewelry_item[purity_id]"]');
      return m && p && m.value && p.value;
    }

    // guard submission: prevent creating without both selections
    document.addEventListener('DOMContentLoaded', function(){
      const form = document.querySelector('form');
      if(!form) return;
      const metalEl = document.querySelector('select[name="jewelry_item[metal_id]"]');
      const purityEl = document.querySelector('select[name="jewelry_item[purity_id]"]');
      if(!metalEl || !purityEl){ setFormEnabled(true); return; }

      // initialize
      setFormEnabled(bothSelected());

      metalEl.addEventListener('change', function(){ setFormEnabled(bothSelected()); });
      purityEl.addEventListener('change', function(){ setFormEnabled(bothSelected()); });

      form.addEventListener('submit', function(e){
        if(!bothSelected()){
          e.preventDefault();
          alert('Please select both Metal and Purity before creating an item.');
        }
      });
    });
    function slugify(s){
      return s.toString().toUpperCase().replace(/[^A-Z0-9]+/g, '').slice(0,10);
    }

    const _ALNUM = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    function rndAlnum(n){
      let out='';
      for(let i=0;i<n;i++) out += _ALNUM.charAt(Math.floor(Math.random()*_ALNUM.length));
      return out;
    }

    const nameEl = document.querySelector('input[name="jewelry_item[name]"]');
    const descEl = document.querySelector('textarea[name="jewelry_item[description]"]');
  const priceRupeesEl = document.getElementById('price_rupees');
  const priceHiddenEl = document.getElementById('price_cents_hidden');
    const weightEl = document.querySelector('input[name="jewelry_item[weight_grams]"]');
    const skuEl = document.querySelector('input[name="jewelry_item[sku]"]');

    const previewTitle = document.getElementById('preview-title');
    const previewSku = document.getElementById('preview-sku');
    const previewPrice = document.getElementById('preview-price');
    const previewWeight = document.getElementById('preview-weight');
    const previewDesc = document.getElementById('preview-desc');

    function updatePreview(){
      if(nameEl) previewTitle.textContent = nameEl.value || 'New item';
      if(descEl) previewDesc.innerHTML = (descEl.value || '').replace(/\n/g,'<br>');
      // show rupees formatted (price_cents hidden field stores integer paise)
      let rupeesText = '‚Äî';
      if(priceHiddenEl && priceHiddenEl.value){
        rupeesText = '\u20B9' + (parseInt(priceHiddenEl.value)/100).toFixed(2);
      } else if(priceRupeesEl && priceRupeesEl.value){
        // user-entered rupees shown immediately
        const v = parseFloat(priceRupeesEl.value);
        if(!isNaN(v)) rupeesText = '\u20B9' + v.toFixed(2);
      }
      previewPrice.textContent = rupeesText;
      if(weightEl) previewWeight.textContent = (parseFloat(weightEl.value || 0)).toFixed(2) + ' g';
      if(skuEl && skuEl.value.trim().length) previewSku.textContent = skuEl.value;
    }

    // generate SKU when name changes, only if sku field is empty (user hasn't manually set it)
    function maybeGenerateSku(){
      if(!skuEl) return;
      // For new form, always prefill SKU if empty. Field is readonly so user can't change it here.
      if(skuEl.value && skuEl.value.trim().length) { previewSku.textContent = skuEl.value; return; }
      const s = nameEl ? slugify(nameEl.value || '') : '';
      if(s){
        const base = s.slice(0,10);
        const need = 10 - base.length;
        const suffix = rndAlnum(need);
        skuEl.value = 'J' + (base + suffix).slice(0,10);
      } else {
        skuEl.value = 'J' + rndAlnum(10);
      }
      previewSku.textContent = skuEl.value || '‚Äî';
    }

    [nameEl, descEl, priceRupeesEl, weightEl, skuEl].forEach(el=>{ if(!el) return; el.addEventListener('input', function(){ updatePreview(); }); });
    if(nameEl) nameEl.addEventListener('input', function(){ maybeGenerateSku(); });

    // sync rupees -> paise hidden field
    if(priceRupeesEl){
      // price_rupees is readonly ‚Äî keep hidden paise in sync when JS updates value
      const syncPriceHidden = function(){
        const v = parseFloat(priceRupeesEl.value);
        if(isNaN(v)) { priceHiddenEl.value = ''; } else { priceHiddenEl.value = Math.round(v * 100); }
      };
      // expose a price update function below that will call syncPriceHidden and updatePreview
    }

    // initial fill
  // initial sync: ensure hidden paise is set if rupees present
    if(priceRupeesEl && priceRupeesEl.value && priceHiddenEl) priceHiddenEl.value = Math.round(parseFloat(priceRupeesEl.value) * 100);
  maybeGenerateSku();
  updatePreview();
  })();
</script>

  <script>
    // Compute price from purity price per gram √ó weight √ó quantity
      (function(){
        // Build purity map from server-side data including effective per-gram price (purity.updated_price or latest metal_stock)
        const PURITIES = <%= (@purities || []).map do |p|
          per_gram = if p.updated_price.present?
            p.updated_price.to_f
          else
            ms = p.metal&.metal_stocks&.order(created_at: :desc)&.first
            (ms && ms.price_cents_per_gram.present?) ? (ms.price_cents_per_gram.to_f / 100.0) : 0.0
          end
          { id: p.id, per_gram_price: per_gram, name: p.name, metal_id: p.metal_id }
        end.to_json.html_safe %>;
        function findPurity(id){ return PURITIES.find(x=>String(x.id) === String(id)); }

        document.addEventListener('DOMContentLoaded', function(){
          const metalEl = document.querySelector('select[name="jewelry_item[metal_id]"]');
          const purityEl = document.querySelector('select[name="jewelry_item[purity_id]"]');
          const weightEl = document.querySelector('input[name="jewelry_item[weight_grams]"]');
          const qtyEl = document.querySelector('input[name="jewelry_item[quantity]"]');
          const priceRupeesEl = document.getElementById('price_rupees');
          const priceHiddenEl = document.getElementById('price_cents_hidden');

          function computeAndSetPrice(){
            if(!priceRupeesEl || !priceHiddenEl) return;
            const purity = purityEl ? findPurity(purityEl.value) : null;
            const perGram = purity && (purity.per_gram_price || purity.per_gram_price === 0) ? parseFloat(purity.per_gram_price) : 0;
            const weight = parseFloat((weightEl && weightEl.value) || 0);
            const qty = parseFloat((qtyEl && qtyEl.value) || 1);
            const total = perGram * (isNaN(weight) ? 0 : weight) * (isNaN(qty) ? 1 : qty);
            priceRupeesEl.value = isNaN(total) ? '' : total.toFixed(2);
            if(priceRupeesEl.value) priceHiddenEl.value = Math.round(parseFloat(priceRupeesEl.value) * 100);
            const previewPrice = document.getElementById('preview-price');
            if(previewPrice) previewPrice.textContent = priceRupeesEl.value ? '\u20B9' + parseFloat(priceRupeesEl.value).toFixed(2) : '‚Äî';
          }

          // Helper: populate purity <select> with purities that match the selected metal
          function populatePurityOptions(selectedMetalId){
            if(!purityEl) return;
            const prev = purityEl.value;
            // build options: blank first
            purityEl.innerHTML = '';
            const blank = document.createElement('option');
            blank.value = '';
            blank.text = '‚Äî Select purity ‚Äî';
            purityEl.appendChild(blank);
            // choose purities matching metalId; if none selected, show all
            const list = PURITIES.filter(function(p){
              return !selectedMetalId || String(p.metal_id) === String(selectedMetalId);
            });
            list.forEach(function(p){
              const opt = document.createElement('option');
              opt.value = p.id;
              opt.text = p.name;
              purityEl.appendChild(opt);
            });
            // restore previous selection if still present
            if(prev){
              const still = Array.prototype.slice.call(purityEl.options).some(o=>String(o.value)===String(prev));
              if(still) purityEl.value = prev; else purityEl.value = '';
            }
          }

          // Attach listeners: purity, weight and quantity
          [purityEl, weightEl, qtyEl].forEach(el=>{ if(!el) return; el.addEventListener('input', computeAndSetPrice); el.addEventListener('change', computeAndSetPrice); });
          if(metalEl){
            // filter purities when metal changes and recompute price
            metalEl.addEventListener('change', function(){
              populatePurityOptions(metalEl.value);
              // allow any other listeners (from other script) to run first
              setTimeout(computeAndSetPrice, 50);
            });
          }

          // Initial populate (respect current metal selection)
          populatePurityOptions(metalEl ? metalEl.value : null);

          // Ensure initial compute runs
          computeAndSetPrice();
        });
      })();
  </script>
