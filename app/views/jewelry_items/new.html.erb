<div class="container">
  <div class="page-header">
    <div>
      <h1>New Jewelry Item</h1>
      <p class="lead">Create a new catalog item ‚Äî set pricing, stock and attributes.</p>
    </div>
    <div class="right">
      <%= link_to 'Back to Catalog', jewelry_items_path, class: 'btn' %>
    </div>
  </div>

  <div class="card">
    <div class="edit-grid">
      <div class="edit-form">
        <%= form_for @item, url: jewelry_items_path do |f| %>
          <div class="form-row">
            <div style="flex:1">
              <%= f.label :name %>
              <%= f.text_field :name, class: 'form-control' %>
            </div>
          </div>

          <div style="margin-top:10px">
            <%= f.label :description %>
            <%= f.text_area :description, rows: 4, class: 'form-control' %>
          </div>

          <div class="form-row" style="margin-top:10px">
            <div style="flex:1">
              <%= f.label :price_cents, 'Price (‚Çπ) ‚Äî enter rupees (decimal)' %>
              <%= text_field_tag 'price_rupees', (@item.price.present? ? ('%.2f' % @item.price) : ''), class: 'form-control', id: 'price_rupees', placeholder: 'e.g. 1234.50' %>
              <%= f.hidden_field :price_cents, id: 'price_cents_hidden' %>
            </div>
            <div style="width:220px;margin-left:12px">
              <%= f.label :quantity, 'Quantity (pieces)' %>
              <%= f.number_field :quantity, step: 1, min: 0, class: 'form-control' %>
            </div>
          </div>

          <div class="form-row" style="margin-top:10px">
            <div style="flex:1">
              <%= f.label :sku %>
              <%= f.text_field :sku, class: 'form-control', readonly: true %>
            </div>
            <div style="width:220px;margin-left:12px">
              <%= f.label :weight_grams, 'Weight (g)' %>
              <%= f.number_field :weight_grams, step: 0.01, class: 'form-control' %>
            </div>
          </div>

          <div style="margin-top:14px">
            <%= f.submit 'Create Item', class: 'btn btn-primary' %>
            <%= link_to 'Cancel', jewelry_items_path, class: 'btn btn-outline' %>
          </div>
        <% end %>
      </div>

      <div class="edit-preview">
        <div class="product-hero card">
          <div class="product-grid">
            <div class="product-media">
              <div class="product-image">üíç</div>
            </div>
            <div class="product-details">
              <h2 id="preview-title" class="product-title"><%= @item.name.presence || 'New item' %></h2>
              <div id="preview-meta" class="product-meta small muted">SKU: <span id="preview-sku"><%= @item.sku.presence || '‚Äî' %></span></div>
              <div class="product-pricing" style="margin-top:12px">
                <div id="preview-price" class="price-large"><%= @item.price.present? ? "\u20B9#{'%.2f' % @item.price}" : '‚Äî' %></div>
                <div class="product-attributes small muted" style="margin-left:12px">
                  <div>Weight: <strong id="preview-weight"><%= @item.weight_grams.to_f %> g</strong></div>
                </div>
              </div>
              <div id="preview-desc" class="product-desc" style="margin-top:10px"><%= simple_format(@item.description.to_s.presence || '') %></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // live preview sync for new/edit forms
  (function(){
    function slugify(s){
      return s.toString().toUpperCase().replace(/[^A-Z0-9]+/g, '').slice(0,10);
    }

    const _ALNUM = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    function rndAlnum(n){
      let out='';
      for(let i=0;i<n;i++) out += _ALNUM.charAt(Math.floor(Math.random()*_ALNUM.length));
      return out;
    }

    const nameEl = document.querySelector('input[name="jewelry_item[name]"]');
    const descEl = document.querySelector('textarea[name="jewelry_item[description]"]');
  const priceRupeesEl = document.getElementById('price_rupees');
  const priceHiddenEl = document.getElementById('price_cents_hidden');
    const weightEl = document.querySelector('input[name="jewelry_item[weight_grams]"]');
    const skuEl = document.querySelector('input[name="jewelry_item[sku]"]');

    const previewTitle = document.getElementById('preview-title');
    const previewSku = document.getElementById('preview-sku');
    const previewPrice = document.getElementById('preview-price');
    const previewWeight = document.getElementById('preview-weight');
    const previewDesc = document.getElementById('preview-desc');

    function updatePreview(){
      if(nameEl) previewTitle.textContent = nameEl.value || 'New item';
      if(descEl) previewDesc.innerHTML = (descEl.value || '').replace(/\n/g,'<br>');
      // show rupees formatted (price_cents hidden field stores integer paise)
      let rupeesText = '‚Äî';
      if(priceHiddenEl && priceHiddenEl.value){
        rupeesText = '\u20B9' + (parseInt(priceHiddenEl.value)/100).toFixed(2);
      } else if(priceRupeesEl && priceRupeesEl.value){
        // user-entered rupees shown immediately
        const v = parseFloat(priceRupeesEl.value);
        if(!isNaN(v)) rupeesText = '\u20B9' + v.toFixed(2);
      }
      previewPrice.textContent = rupeesText;
      if(weightEl) previewWeight.textContent = (parseFloat(weightEl.value || 0)).toFixed(2) + ' g';
      if(skuEl && skuEl.value.trim().length) previewSku.textContent = skuEl.value;
    }

    // generate SKU when name changes, only if sku field is empty (user hasn't manually set it)
    function maybeGenerateSku(){
      if(!skuEl) return;
      // For new form, always prefill SKU if empty. Field is readonly so user can't change it here.
      if(skuEl.value && skuEl.value.trim().length) { previewSku.textContent = skuEl.value; return; }
      const s = nameEl ? slugify(nameEl.value || '') : '';
      if(s){
        const base = s.slice(0,10);
        const need = 10 - base.length;
        const suffix = rndAlnum(need);
        skuEl.value = 'J' + (base + suffix).slice(0,10);
      } else {
        skuEl.value = 'J' + rndAlnum(10);
      }
      previewSku.textContent = skuEl.value || '‚Äî';
    }

    [nameEl, descEl, priceRupeesEl, weightEl, skuEl].forEach(el=>{ if(!el) return; el.addEventListener('input', function(){ updatePreview(); }); });
    if(nameEl) nameEl.addEventListener('input', function(){ maybeGenerateSku(); });

    // sync rupees -> paise hidden field
    if(priceRupeesEl){
      priceRupeesEl.addEventListener('input', function(){
        const v = parseFloat(priceRupeesEl.value);
        if(isNaN(v)) { priceHiddenEl.value = ''; } else { priceHiddenEl.value = Math.round(v * 100); }
        updatePreview();
      });
    }

    // initial fill
  // initial sync: ensure hidden paise is set if rupees present
  if(priceRupeesEl && priceRupeesEl.value && priceHiddenEl) priceHiddenEl.value = Math.round(parseFloat(priceRupeesEl.value) * 100);
  maybeGenerateSku();
  updatePreview();
  })();
</script>
